name: Build and Push Containers
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Custom tag for the images (defaults to timestamp)'
        required: false
        type: string
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  # Don't cancel in-progress builds - they take 60+ minutes and frequent commits
  # would prevent any build from completing
  cancel-in-progress: false
env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }} # This will be owner/repo format
permissions:
  contents: read
  packages: write
jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      tag: ${{ steps.tags.outputs.tag }}
      should-push: ${{ steps.tags.outputs.should-push }}
      platforms: ${{ steps.tags.outputs.platforms }}
      devcontainer-platforms: ${{ steps.tags.outputs.devcontainer-platforms }}
    steps:
      - name: Generate tags and determine build strategy
        id: tags
        run: |
          # Determine tag
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG=$(date +%Y%m%d_%H%M%S)
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

          # Always push since we only run on main or workflow dispatch
          echo "should-push=true" >> $GITHUB_OUTPUT
          # Both main app and devcontainer need multi-arch
          echo "platforms=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
          echo "devcontainer-platforms=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
  smoke-test:
    needs: [prepare]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1
      - name: Run image smoke test
        uses: ./.github/actions/smoke-test-action
        with:
          image-tag: smoke-test
          registry: ${{ env.REGISTRY }}
          image-prefix: ${{ env.IMAGE_PREFIX }}

  build-devcontainer:
    needs: [prepare, smoke-test]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h
      - name: Checkout code
        uses: actions/checkout@v6.0.1
      - name: Set up QEMU
        if: needs.prepare.outputs.devcontainer-platforms != 'linux/amd64'
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Container Registry
        if: needs.prepare.outputs.should-push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and conditionally push devcontainer image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .devcontainer/Dockerfile
          platforms: ${{ needs.prepare.outputs.devcontainer-platforms }}
          push: ${{ needs.prepare.outputs.should-push }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-${{ needs.prepare.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-main
          cache-from: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-main
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:cache-devcontainer-dev
          cache-to: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:cache-devcontainer-dev,mode=max
  build-main:
    needs: [prepare, smoke-test]
    runs-on: ubuntu-latest
    timeout-minutes: 120 # 2 hours for build
    steps:
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h
      - name: Checkout code
        uses: actions/checkout@v6.0.1
      - name: Set up QEMU
        if: needs.prepare.outputs.platforms != 'linux/amd64'
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Container Registry
        if: needs.prepare.outputs.should-push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and conditionally push main application image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: ${{ needs.prepare.outputs.platforms }}
          push: ${{ needs.prepare.outputs.should-push }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:${{ needs.prepare.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:main
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:buildcache
          cache-from: |
            type=gha
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:main
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:buildcache,mode=max

      - name: Generate GitHub App token
        if: needs.prepare.outputs.should-push == 'true'
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.IMAGE_UPDATER_APP_ID }}
          private-key: ${{ secrets.IMAGE_UPDATER_PRIVATE_KEY }}
          owner: werdnum
          # repositories: kube-config

      - name: Update kube-config
        if: needs.prepare.outputs.should-push == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          IMAGE_DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          set -e

          NEW_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}@${IMAGE_DIGEST}"
          DEPLOYMENT_PATH="kubernetes/manifests/workloads/family-assistant/Deployment-family-assistant.yaml"

          git clone "https://x-access-token:${GH_TOKEN}@github.com/werdnum/kube-config.git" kube-config
          cd kube-config

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          yq eval -i "(.spec.template.spec.containers[] | select(.name == \"family-assistant\") | .image) = \"${NEW_IMAGE}\"" \
            "${DEPLOYMENT_PATH}"

          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add "${DEPLOYMENT_PATH}"
            git commit -m "chore(family-assistant): update image to ${IMAGE_DIGEST:0:12}

          Source: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
            git push
            echo "Updated kube-config with new image"
          fi

