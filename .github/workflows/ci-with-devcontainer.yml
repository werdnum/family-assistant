name: CI with Dev Container
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
permissions:
  contents: read
  packages: write
  pull-requests: read
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.tag.outputs.tag }}
      image-name: ${{ steps.tag.outputs.image }}
    steps:
      - name: Generate image tag
        id: tag
        run: |
          TAG="ci-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-${TAG}" >> $GITHUB_OUTPUT

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      has_code_changes: ${{ steps.filter.outputs.has_code_changes }}
      frontend_source: ${{ steps.filter.outputs.frontend_source }}
      frontend_tests: ${{ steps.filter.outputs.frontend_tests }}
      backend_source: ${{ steps.filter.outputs.backend_source }}
      backend_tests_unit: ${{ steps.filter.outputs.backend_tests_unit }}
      backend_tests_playwright: ${{ steps.filter.outputs.backend_tests_playwright }}
      ci_workflow: ${{ steps.filter.outputs.ci_workflow }}
      web_api: ${{ steps.filter.outputs.web_api }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            # Detect if there are any code changes (anything NOT in the docs-only list)
            has_code_changes:
              - '!docs/**'
              - '!*.md'
              - '!.claude/**'
              - '!.serena/**'
              - '!.github/workflows/gemini-*.yml'
              - '!.github/workflows/build-containers.yml'
              - '!.github/dependabot.yml'
              - '!.devcontainer/claude-wrapper.sh'
              - '!.devcontainer/throttle_backspaces.py'
              - '!.devcontainer/setup-workspace.sh'
              - '!.devcontainer/run-claude-isolated.sh'
              - '!.devcontainer/run-oneshot.sh'
              - '!.devcontainer/merge-settings.py'
              - '!.devcontainer/*.md'
              - '!contrib/**'
              - '!.gitignore'
              - '!.dockerignore'
              - '!.markdownlint.json'
              - '!.mdformat.toml'
              - '!aider.yaml'
              - '!.mcp.json'
              - '!mcp_config.dev.json'
              - '!.build'
            frontend_source:
              - 'frontend/src/**'
              - 'frontend/*.html'
              - 'frontend/*.json'
              - 'frontend/*.js'
              - 'frontend/package*.json'
            frontend_tests:
              - 'frontend/**/*.test.*'
              - 'frontend/**/__tests__/**'
            backend_source:
              - 'src/**/*.py'
            backend_tests_unit:
              - 'tests/**/*.py'
            backend_tests_playwright:
              - 'tests/functional/web/test_*.py'
            ci_workflow:
              - '.github/workflows/ci-*.yml'
            web_api:
              - 'src/family_assistant/web/**/*.py'
  build-ci-container:
    needs: [prepare, detect-changes]
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45 # Increased timeout for two-stage build
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Cache warming - pull base images for better cache hits
        run: |
          docker pull ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-latest || true
          docker pull ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache || true
      - name: Build base devcontainer image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .devcontainer/Dockerfile
          platforms: linux/amd64 # Single arch for CI speed
          push: true # Push to registry for next stage access
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-base-${{ github.run_id }}
          cache-from: |
            type=gha
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-main
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache,mode=max
      - name: Build CI devcontainer image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .devcontainer/Dockerfile.ci
          platforms: linux/amd64 # Single arch for CI speed
          push: true
          tags: ${{ needs.prepare.outputs.image-name }}
          cache-from: |
            type=gha
            type=registry,ref=ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-main
            type=registry,ref=ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache,mode=max
          build-args: |
            BASE_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-base-${{ github.run_id }}
          load: false
  lint:
    needs: [prepare, build-ci-container, detect-changes]
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run linting in devcontainer
        run: |
          docker run \
            --rm \
            -v ${{ github.workspace }}:/workspace/main \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend/node_modules" ] && [ ! -d "frontend/node_modules" ]; then \
                echo "Symlinking pre-installed node_modules for frontend linting..."; \
                ln -s /opt/frontend/node_modules frontend/node_modules; \
              fi && \
              scripts/format-and-lint.sh'
  test-frontend-unit:
    needs: [prepare, build-ci-container, detect-changes]
    if: |
      needs.detect-changes.outputs.has_code_changes == 'true' &&
      (needs.detect-changes.outputs.frontend_source == 'true' ||
       needs.detect-changes.outputs.frontend_tests == 'true' ||
       needs.detect-changes.outputs.ci_workflow == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run frontend tests in devcontainer
        run: |
          docker run \
            --rm \
            -v ${{ github.workspace }}:/workspace/main \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -e CI=true \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend/node_modules" ] && [ ! -d "frontend/node_modules" ]; then \
                echo "Symlinking pre-installed node_modules for frontend tests..."; \
                ln -s /opt/frontend/node_modules frontend/node_modules; \
              fi && \
              mkdir -p test-results && \
              npm test --prefix frontend -- --run --reporter=json --reporter=verbose --outputFile=test-results/frontend-report.json'
      - name: Upload frontend test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results-${{ github.run_id }}
          path: test-results/frontend-report.json
          retention-days: 7
          if-no-files-found: ignore
  test-backend-sqlite:
    needs: [prepare, build-ci-container, detect-changes]
    if: |
      needs.detect-changes.outputs.has_code_changes == 'true' &&
      (needs.detect-changes.outputs.backend_source == 'true' ||
       needs.detect-changes.outputs.backend_tests_unit == 'true' ||
       needs.detect-changes.outputs.ci_workflow == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run backend SQLite tests in devcontainer
        run: |
          docker run \
            --rm \
            -v ${{ github.workspace }}:/workspace/main \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -e CI=true \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend-dist" ]; then \
                echo "Copying pre-built frontend assets..."; \
                mkdir -p /workspace/main/src/family_assistant/static/dist; \
                cp -r /opt/frontend-dist/. /workspace/main/src/family_assistant/static/dist/; \
                echo "Frontend assets copied successfully"; \
                ls -la /workspace/main/src/family_assistant/static/dist/; \
              else \
                echo "No pre-built frontend assets found at /opt/frontend-dist"; \
              fi && \
              mkdir -p test-results && \
              .venv/bin/pytest -q --timeout=300 --db sqlite -m "not postgres and not playwright" \
                --json-report --json-report-file=test-results/backend-sqlite-report.json'
      - name: Upload backend test results (SQLite)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-artifacts-sqlite-${{ github.run_id }}
          path: test-results/backend-sqlite-report.json
          retention-days: 7
          if-no-files-found: ignore
  test-backend-postgres:
    needs: [prepare, build-ci-container, detect-changes]
    if: |
      needs.detect-changes.outputs.has_code_changes == 'true' &&
      (needs.detect-changes.outputs.backend_source == 'true' ||
       needs.detect-changes.outputs.backend_tests_unit == 'true' ||
       needs.detect-changes.outputs.ci_workflow == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: pgvector/pgvector:0.8.0-pg17
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run backend PostgreSQL tests in devcontainer
        run: |
          docker run \
            --rm \
            --network host \
            -v ${{ github.workspace }}:/workspace/main \
            -e TEST_DATABASE_URL="postgresql://test:test@localhost:5432/test" \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -e CI=true \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend-dist" ]; then \
                echo "Copying pre-built frontend assets..."; \
                mkdir -p /workspace/main/src/family_assistant/static/dist; \
                cp -r /opt/frontend-dist/. /workspace/main/src/family_assistant/static/dist/; \
                echo "Frontend assets copied successfully"; \
                ls -la /workspace/main/src/family_assistant/static/dist/; \
              else \
                echo "No pre-built frontend assets found at /opt/frontend-dist"; \
              fi && \
              mkdir -p test-results && \
              .venv/bin/pytest --postgres -q --timeout=300 -m "not playwright" \
                --json-report --json-report-file=test-results/backend-postgres-report.json'
      - name: Upload backend test results (PostgreSQL)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-artifacts-postgres-${{ github.run_id }}
          path: test-results/backend-postgres-report.json
          retention-days: 7
          if-no-files-found: ignore

  test-playwright-sqlite:
    needs: [prepare, build-ci-container, detect-changes]
    if: |
      needs.detect-changes.outputs.has_code_changes == 'true' &&
      (needs.detect-changes.outputs.frontend_source == 'true' ||
       needs.detect-changes.outputs.backend_source == 'true' ||
       needs.detect-changes.outputs.web_api == 'true' ||
       needs.detect-changes.outputs.backend_tests_playwright == 'true' ||
       needs.detect-changes.outputs.ci_workflow == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run Playwright tests with SQLite in devcontainer
        run: |
          docker run \
            --rm \
            -v ${{ github.workspace }}:/workspace/main \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -e CI=true \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend-dist" ]; then \
                echo "Copying pre-built frontend assets..."; \
                mkdir -p /workspace/main/src/family_assistant/static/dist; \
                cp -r /opt/frontend-dist/. /workspace/main/src/family_assistant/static/dist/; \
                echo "Frontend assets copied successfully"; \
                ls -la /workspace/main/src/family_assistant/static/dist/; \
              else \
                echo "No pre-built frontend assets found at /opt/frontend-dist"; \
              fi && \
              mkdir -p test-results && \
              .venv/bin/pytest -q --timeout=300 --db sqlite -m "playwright" \
                --screenshot=on --video=retain-on-failure --tracing=retain-on-failure \
                --json-report --json-report-file=test-results/playwright-sqlite-report.json \
                --output=test-results'
      - name: Upload Playwright test artifacts (SQLite)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-artifacts-sqlite-${{ github.run_id }}
          path: |
            test-results/
            /tmp/history_page_*.png
          retention-days: 7
          if-no-files-found: ignore
      - name: Output artifact info
        if: always()
        run: |
          echo "üîç Debug artifacts uploaded to: playwright-artifacts-sqlite-${{ github.run_id }}"
          echo "üìä JSON test report: test-results/playwright-sqlite-report.json"
          echo "üì± Screenshots: test-results/**/test-failed-*.png"
          echo "üé• Videos: test-results/**/test-*.webm"
          echo "üïµÔ∏è Traces: test-results/**/trace.zip"
          echo ""
          echo "üí° Download with: gh run download ${{ github.run_id }} --name playwright-artifacts-sqlite-${{ github.run_id }}"

  test-playwright-postgres:
    needs: [prepare, build-ci-container, detect-changes]
    if: |
      needs.detect-changes.outputs.has_code_changes == 'true' &&
      (needs.detect-changes.outputs.frontend_source == 'true' ||
       needs.detect-changes.outputs.backend_source == 'true' ||
       needs.detect-changes.outputs.web_api == 'true' ||
       needs.detect-changes.outputs.backend_tests_playwright == 'true' ||
       needs.detect-changes.outputs.ci_workflow == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: pgvector/pgvector:0.8.0-pg17
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run Playwright tests with PostgreSQL in devcontainer
        run: |
          docker run \
            --rm \
            --network host \
            -v ${{ github.workspace }}:/workspace/main \
            -e TEST_DATABASE_URL="postgresql://test:test@localhost:5432/test" \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -e CI=true \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend-dist" ]; then \
                echo "Copying pre-built frontend assets..."; \
                mkdir -p /workspace/main/src/family_assistant/static/dist; \
                cp -r /opt/frontend-dist/. /workspace/main/src/family_assistant/static/dist/; \
                echo "Frontend assets copied successfully"; \
                ls -la /workspace/main/src/family_assistant/static/dist/; \
              else \
                echo "No pre-built frontend assets found at /opt/frontend-dist"; \
              fi && \
              mkdir -p test-results && \
              .venv/bin/pytest --postgres -q --timeout=300 -m "playwright" \
                --screenshot=on --video=retain-on-failure --tracing=retain-on-failure \
                --json-report --json-report-file=test-results/playwright-postgres-report.json \
                --output=test-results'
      - name: Upload Playwright test artifacts (PostgreSQL)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-artifacts-postgres-${{ github.run_id }}
          path: |
            test-results/
            /tmp/history_page_*.png
          retention-days: 7
          if-no-files-found: ignore
      - name: Output artifact info
        if: always()
        run: |
          echo "üîç Debug artifacts uploaded to: playwright-artifacts-postgres-${{ github.run_id }}"
          echo "üìä JSON test report: test-results/playwright-postgres-report.json"
          echo "üì± Screenshots: test-results/**/test-failed-*.png"
          echo "üé• Videos: test-results/**/test-*.webm"
          echo "üïµÔ∏è Traces: test-results/**/trace.zip"
          echo ""
          echo "üí° Download with: gh run download ${{ github.run_id }} --name playwright-artifacts-postgres-${{ github.run_id }}"

  # Require all test jobs to pass
  all-tests:
    needs: [lint, test-frontend-unit, test-backend-sqlite, test-backend-postgres, test-playwright-sqlite, test-playwright-postgres]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all tests passed
        run: |
          # Job results can be: success, failure, cancelled, skipped
          # We fail if any job failed or was cancelled
          # Skipped jobs are OK (means they were intentionally skipped by conditionals)

          function check_job() {
            local job_name=$1
            local job_result=$2

            if [[ "$job_result" == "failure" || "$job_result" == "cancelled" ]]; then
              echo "‚ùå $job_name: $job_result"
              return 1
            elif [[ "$job_result" == "skipped" ]]; then
              echo "‚è≠Ô∏è  $job_name: skipped"
              return 0
            elif [[ "$job_result" == "success" ]]; then
              echo "‚úÖ $job_name: success"
              return 0
            else
              echo "‚ùì $job_name: unknown status ($job_result)"
              return 1
            fi
          }

          echo "Checking test results..."
          FAILED=0

          check_job "lint" "${{ needs.lint.result }}" || FAILED=1
          check_job "test-frontend-unit" "${{ needs.test-frontend-unit.result }}" || FAILED=1
          check_job "test-backend-sqlite" "${{ needs.test-backend-sqlite.result }}" || FAILED=1
          check_job "test-backend-postgres" "${{ needs.test-backend-postgres.result }}" || FAILED=1
          check_job "test-playwright-sqlite" "${{ needs.test-playwright-sqlite.result }}" || FAILED=1
          check_job "test-playwright-postgres" "${{ needs.test-playwright-postgres.result }}" || FAILED=1

          if [[ $FAILED -eq 1 ]]; then
            echo ""
            echo "‚ùå One or more test jobs failed"
            exit 1
          fi

          echo ""
          echo "‚úÖ All tests passed or were skipped!"

# Note: Test images with unique tags will be cleaned up by GHCR retention policies

