name: CI with Dev Container

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

permissions:
  contents: read
  packages: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Generate image tag
      id: tag
      run: |
        TAG="ci-${{ github.run_id }}-${{ github.run_attempt }}"
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-devcontainer:${TAG}" >> $GITHUB_OUTPUT
    
    - name: Build devcontainer image
      uses: docker/build-push-action@v5
      with:
        context: .devcontainer
        file: .devcontainer/Dockerfile
        push: true
        tags: ${{ steps.tag.outputs.image }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: false
    
    - name: Run tests in devcontainer
      run: |
        # Run the container with the just-built image
        # PostgreSQL will be started as a subprocess inside the container
        docker run \
          --rm \
          -v ${{ github.workspace }}:/workspace \
          --user root \
          ${{ steps.tag.outputs.image }} \
          bash -c '
            # Set up workspace permissions
            chown -R claude:claude /workspace
            
            # Switch to claude user for all operations
            su - claude -c "
              cd /workspace
              
              # Configure git
              git config --global --add safe.directory /workspace
              
              # Create virtual environment and install dependencies
              uv venv .venv
              uv pip install --python .venv \".[dev]\"
              
              # Install playwright browsers
              .venv/bin/playwright install chromium
              
              # Run linting
              echo \"Running linting...\"
              scripts/format-and-lint.sh
              
              # Run tests with SQLite
              echo \"Running SQLite tests...\"
              .venv/bin/pytest -xq
              
              # Run tests with PostgreSQL using subprocess
              echo \"Running PostgreSQL tests with subprocess...\"
              # The tests will automatically use SubprocessPostgresContainer when
              # PostgreSQL is installed but no external PostgreSQL is available
              .venv/bin/pytest --postgres -xq
            "
          '
    
    # Note: Test images with unique tags will be cleaned up by GHCR retention policies
