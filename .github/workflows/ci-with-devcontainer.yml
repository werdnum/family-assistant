name: CI with Dev Container

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

permissions:
  contents: read
  packages: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: pgvector/pgvector:0.8.0-pg17
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Generate image tag
      id: tag
      run: |
        TAG="ci-${{ github.run_id }}-${{ github.run_attempt }}"
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-devcontainer:${TAG}" >> $GITHUB_OUTPUT
    
    - name: Create cache directory
      run: mkdir -p ${{ runner.temp }}/uv-cache
    
    - name: Build devcontainer image
      uses: docker/build-push-action@v5
      with:
        context: .devcontainer
        file: .devcontainer/Dockerfile
        push: true
        tags: ${{ steps.tag.outputs.image }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: false
    
    - name: Run tests in devcontainer
      run: |
        # Run the container with the just-built image
        # Let the dev container's entrypoint handle setup
        # Override CMD to run our tests instead of claude
        docker run \
          --rm \
          --network host \
          -v ${{ github.workspace }}:/workspace \
          -v ${{ runner.temp }}/uv-cache:/home/claude/.cache/uv \
          -e TEST_DATABASE_URL="postgresql://test:test@localhost:5432/test" \
          -e CLAUDE_PROJECT_REPO="" \
          -e UV_CACHE_DIR=/home/claude/.cache/uv \
          -u claude \
          ${{ steps.tag.outputs.image }} \
          bash -c '
            cd /workspace
            
            # The entrypoint has already set up the environment
            # Just run our tests
            echo "Running linting..."
            scripts/format-and-lint.sh
            
            echo "Running SQLite tests..."
            .venv/bin/pytest -xq
            
            echo "Running PostgreSQL tests with external service..."
            .venv/bin/pytest --postgres -xq
          '
    
    # Note: Test images with unique tags will be cleaned up by GHCR retention policies
