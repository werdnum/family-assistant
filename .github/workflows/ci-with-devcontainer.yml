name: CI with Dev Container
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
permissions:
  contents: read
  packages: write
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.tag.outputs.tag }}
      image-name: ${{ steps.tag.outputs.image }}
    steps:
      - name: Generate image tag
        id: tag
        run: |
          TAG="ci-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-${TAG}" >> $GITHUB_OUTPUT
  build-ci-container:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 45 # Increased timeout for two-stage build
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Cache warming - pull base images for better cache hits
        run: |
          docker pull ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-latest || true
          docker pull ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache || true
      - name: Build base devcontainer image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .devcontainer/Dockerfile
          platforms: linux/amd64 # Single arch for CI speed
          push: true # Push to registry for next stage access
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-base-${{ github.run_id }}
          cache-from: |
            type=gha
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-main
            type=registry,ref=ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache,mode=max
      - name: Build CI devcontainer image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .devcontainer/Dockerfile.ci
          platforms: linux/amd64 # Single arch for CI speed
          push: true
          tags: ${{ needs.prepare.outputs.image-name }}
          cache-from: |
            type=gha
            type=registry,ref=ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-main
            type=registry,ref=ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=ghcr.io/${{ env.IMAGE_PREFIX }}:devcontainer-buildcache,mode=max
          build-args: |
            BASE_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}:devcontainer-base-${{ github.run_id }}
          load: false
  lint:
    needs: [prepare, build-ci-container]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run linting in devcontainer
        run: |
          docker run \
            --rm \
            -v ${{ github.workspace }}:/workspace/main \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend/node_modules" ] && [ ! -d "frontend/node_modules" ]; then \
                echo "Symlinking pre-installed node_modules for frontend linting..."; \
                ln -s /opt/frontend/node_modules frontend/node_modules; \
              fi && \
              scripts/format-and-lint.sh'
  test-frontend:
    needs: [prepare, build-ci-container]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run frontend tests in devcontainer
        run: |
          docker run \
            --rm \
            -v ${{ github.workspace }}:/workspace/main \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -e CI=true \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend/node_modules" ] && [ ! -d "frontend/node_modules" ]; then \
                echo "Symlinking pre-installed node_modules for frontend tests..."; \
                ln -s /opt/frontend/node_modules frontend/node_modules; \
              fi && \
              mkdir -p test-results && \
              npm test --prefix frontend -- --run --reporter=json --reporter=verbose --outputFile=test-results/frontend-report.json'
      - name: Upload frontend test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results-${{ github.run_id }}
          path: test-results/frontend-report.json
          retention-days: 7
          if-no-files-found: ignore
  test-sqlite:
    needs: [prepare, build-ci-container]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run SQLite tests in devcontainer
        run: |
          docker run \
            --rm \
            -v ${{ github.workspace }}:/workspace/main \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -e CI=true \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend-dist" ]; then \
                echo "Copying pre-built frontend assets..."; \
                mkdir -p /workspace/main/src/family_assistant/static/dist; \
                cp -r /opt/frontend-dist/* /workspace/main/src/family_assistant/static/dist/; \
                # Also copy the .vite directory which contains the manifest \
                [ -d "/opt/frontend-dist/.vite" ] && cp -r /opt/frontend-dist/.vite /workspace/main/src/family_assistant/static/dist/.vite; \
                echo "Frontend assets copied successfully"; \
                ls -la /workspace/main/src/family_assistant/static/dist/; \
              else \
                echo "No pre-built frontend assets found at /opt/frontend-dist"; \
              fi && \
              mkdir -p test-results && \
              .venv/bin/pytest -q --timeout=300 --db sqlite -m "not postgres" \
                --screenshot=on --video=retain-on-failure --tracing=retain-on-failure \
                --json-report --json-report-file=test-results/sqlite-report.json \
                --output=test-results'
      - name: Upload Playwright test artifacts (SQLite)
        uses: actions/upload-artifact@v4
        if: always() # Upload artifacts even if tests fail
        with:
          name: playwright-artifacts-sqlite-${{ github.run_id }}
          path: |
            test-results/
            /tmp/history_page_*.png
          retention-days: 7
          if-no-files-found: ignore
      - name: Output artifact info
        if: always()
        run: |
          echo "üîç Debug artifacts uploaded to: playwright-artifacts-sqlite-${{ github.run_id }}"
          echo "üìä JSON test report: test-results/sqlite-report.json"
          echo "üì± Screenshots: test-results/**/test-failed-*.png"
          echo "üé• Videos: test-results/**/test-*.webm"
          echo "üïµÔ∏è Traces: test-results/**/trace.zip"
          echo ""
          echo "üí° Download with: gh run download ${{ github.run_id }} --name playwright-artifacts-sqlite-${{ github.run_id }}"
  test-postgres:
    needs: [prepare, build-ci-container]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: pgvector/pgvector:0.8.0-pg17
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run PostgreSQL tests in devcontainer
        run: |
          docker run \
            --rm \
            --network host \
            -v ${{ github.workspace }}:/workspace/main \
            -e TEST_DATABASE_URL="postgresql://test:test@localhost:5432/test" \
            -e CLAUDE_PROJECT_REPO="" \
            -e UV_CACHE_DIR=/opt/uv-cache \
            -e CI=true \
            -u claude \
            ${{ needs.prepare.outputs.image-name }} \
            bash -c 'cd /workspace/main && \
              if [ -d "/opt/frontend-dist" ]; then \
                echo "Copying pre-built frontend assets..."; \
                mkdir -p /workspace/main/src/family_assistant/static/dist; \
                cp -r /opt/frontend-dist/* /workspace/main/src/family_assistant/static/dist/; \
                # Also copy the .vite directory which contains the manifest \
                [ -d "/opt/frontend-dist/.vite" ] && cp -r /opt/frontend-dist/.vite /workspace/main/src/family_assistant/static/dist/.vite; \
                echo "Frontend assets copied successfully"; \
                ls -la /workspace/main/src/family_assistant/static/dist/; \
              else \
                echo "No pre-built frontend assets found at /opt/frontend-dist"; \
              fi && \
              mkdir -p test-results && \
              .venv/bin/pytest --postgres -q --timeout=300 \
                --screenshot=on --video=retain-on-failure --tracing=retain-on-failure \
                --json-report --json-report-file=test-results/postgres-report.json \
                --output=test-results'
      - name: Upload Playwright test artifacts (PostgreSQL)
        uses: actions/upload-artifact@v4
        if: always() # Upload artifacts even if tests fail
        with:
          name: playwright-artifacts-postgres-${{ github.run_id }}
          path: |
            test-results/
            /tmp/history_page_*.png
          retention-days: 7
          if-no-files-found: ignore
      - name: Output artifact info
        if: always()
        run: |
          echo "üîç Debug artifacts uploaded to: playwright-artifacts-postgres-${{ github.run_id }}"
          echo "üìä JSON test report: test-results/postgres-report.json"
          echo "üì± Screenshots: test-results/**/test-failed-*.png"
          echo "üé• Videos: test-results/**/test-*.webm"
          echo "üïµÔ∏è Traces: test-results/**/trace.zip"
          echo ""
          echo "üí° Download with: gh run download ${{ github.run_id }} --name playwright-artifacts-postgres-${{ github.run_id }}"
  # Require all test jobs to pass
  all-tests:
    needs: [lint, test-frontend, test-sqlite, test-postgres]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all tests passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" || \
                "${{ needs.test-frontend.result }}" != "success" || \
                "${{ needs.test-sqlite.result }}" != "success" || \
                "${{ needs.test-postgres.result }}" != "success" ]]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "All tests passed!"

# Note: Test images with unique tags will be cleaned up by GHCR retention policies

