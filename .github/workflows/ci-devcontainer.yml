name: Run tests in dev container

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  # PostgreSQL connection string for tests
  DB_URL: postgresql://postgres:postgres@postgres:5432/postgres

permissions:
  contents: read
  packages: read

jobs:
  test-in-devcontainer:
    runs-on: ubuntu-latest
    container:
      # Use the latest devcontainer image from GHCR
      image: ghcr.io/${{ github.repository }}-devcontainer:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root
      # Mount the workspace to the expected location
      volumes:
        - ${{ github.workspace }}:/workspace
    
    services:
      postgres:
        image: pgvector/pgvector:0.8.0-pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    # Note: actions/checkout checks out to $GITHUB_WORKSPACE which we mount to /workspace
    - uses: actions/checkout@v4
    
    - name: Set up workspace permissions
      run: |
        # Ensure the claude user can access the workspace
        chown -R claude:claude /workspace
        # Ensure git directory is safe for claude user
        su - claude -c "git config --global --add safe.directory /workspace"
        
    - name: Create virtual environment and install dependencies
      run: |
        # Create .venv as claude user
        su - claude -c "cd /workspace && uv venv .venv"
        # Install project with dev dependencies
        su - claude -c "cd /workspace && uv pip install --python .venv '.[dev]'"
        
    - name: Install playwright browsers
      run: |
        # Install playwright browsers as claude user
        su - claude -c "cd /workspace && .venv/bin/playwright install chromium"
        
    - name: Run linting
      run: |
        su - claude -c "cd /workspace && scripts/format-and-lint.sh"
        
    - name: Run tests with SQLite
      run: |
        su - claude -c "cd /workspace && .venv/bin/pytest -xq"
        
    - name: Run tests with PostgreSQL
      run: |
        # Pass the DATABASE_URL to the claude user's environment
        su - claude -c "cd /workspace && DATABASE_URL='${{ env.DB_URL }}' .venv/bin/pytest --postgres -xq"
