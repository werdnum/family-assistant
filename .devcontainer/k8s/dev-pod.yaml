apiVersion: v1
kind: Service
metadata:
  name: family-assistant-dev
  namespace: family-assistant-dev
spec:
  clusterIP: None # This makes the service "headless", which is required for StatefulSets
  selector:
    app: family-assistant-dev
  ports:
    - name: backend
      port: 8000
      targetPort: 8000
    - name: frontend
      port: 5173
      targetPort: 5173
    - name: postgres
      port: 5432
      targetPort: 5432
    - name: claude-webui
      port: 8080
      targetPort: 8080
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: family-assistant-dev
  namespace: family-assistant-dev
spec:
  serviceName: "family-assistant-dev"
  replicas: 1 # You can scale this up later
  selector:
    matchLabels:
      app: family-assistant-dev
  template:
    metadata:
      labels:
        app: family-assistant-dev
    spec:
      securityContext:
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
      initContainers:
      # Setup workspace and fix permissions
      - name: setup-workspace
        image: containers.alexsmith.dev/family-assistant-devcontainer:20250711_100358
        imagePullPolicy: Always
        command: ["/usr/local/bin/setup-workspace.sh"]
        securityContext:
          runAsUser: 0  # Run as root for setup
        env:
        - name: CLAUDE_PROJECT_REPO
          value: "https://github.com/werdnum/family-assistant.git"
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-token
              key: token
        volumeMounts:
        - name: workspace
          mountPath: /workspace
        - name: claude-home
          mountPath: /home/claude
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
      containers:
      # PostgreSQL container
      - name: postgres
        image: pgvector/pgvector:0.8.0-pg17
        ports:
        - containerPort: 5432
        securityContext:
          runAsUser: 999  # postgres user in the container
          runAsGroup: 999
          allowPrivilegeEscalation: false
        env:
        - name: POSTGRES_USER
          value: "test"
        - name: POSTGRES_PASSWORD
          value: "test"
        - name: POSTGRES_DB
          value: "test"
        - name: PGDATA
          value: "/var/lib/postgresql/data/pgdata"
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        livenessProbe:
          exec:
            command: ["pg_isready", "-U", "test"]
          initialDelaySeconds: 30
          periodSeconds: 10
      
      # Backend service container
      - name: backend
        image: containers.alexsmith.dev/family-assistant-devcontainer:20250711_100358
        imagePullPolicy: Always
        workingDir: /workspace
        command: ["/bin/bash", "-c"]
        args:
          - |
            cd /workspace
            source .venv/bin/activate
            
            
            # Wait for postgres
            echo "Waiting for PostgreSQL..."
            for i in {1..30}; do
              if pg_isready -h localhost -U test; then
                echo "PostgreSQL is ready!"
                break
              fi
              sleep 1
            done
            
            # Start backend in full development mode
            # This runs both the backend server AND the frontend dev server
            exec poe dev
        ports:
        - containerPort: 8000
        - containerPort: 5173
        env:
        - name: DATABASE_URL
          value: "postgresql+asyncpg://test:test@localhost:5432/test"
        - name: TEST_DATABASE_URL
          value: "postgresql+asyncpg://test:test@localhost:5432/test"
        - name: DEV_MODE
          value: "true"
        - name: HOME
          value: "/home/claude"
        volumeMounts:
        - name: workspace
          mountPath: /workspace
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "2Gi"
            cpu: "1"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
      # Claude Code container
      - name: claude
        image: containers.alexsmith.dev/family-assistant-devcontainer:20250711_100358
        imagePullPolicy: Always
        workingDir: /workspace
        tty: true
        stdin: true
        ports:
        - containerPort: 8080
        command: ["/bin/bash", "-c"]
        args:
          - |
            cd /workspace
            source .venv/bin/activate
            
            # Ensure NPM_CONFIG_PREFIX is set
            export NPM_CONFIG_PREFIX=/home/claude/.npm-global
            
            # Configure MCP servers
            echo "Configuring MCP servers..."
            claude mcp list | cut -d: -f1 | xargs -I: claude mcp remove --scope user :
            claude mcp add --scope user context7 $(which npx) -- -y -q @upstash/context7-mcp
            claude mcp add --scope user scraper /workspace-bin/scrape_mcp
            claude mcp add --scope user serena -- sh -c "$(which uvx) -q --from git+https://github.com/oraios/serena serena-mcp-server --context ide-assistant --project /workspace"
            claude mcp add --scope user playwright $(which npx) -- -y -q @playwright/mcp@latest --allowed-origins "localhost:8000;localhost:5173;localhost:8001;unpkg.com;cdn.jsdelivr.net;cdnjs.cloudflare.com;cdn.simplecss.org" --headless --isolated --browser chromium
            echo "MCP servers configured!"
            
            # CLAUDE.md is now in /home/claude/.claude/CLAUDE.md (mounted volume)
            
            echo "Claude Code environment ready!"
            echo "Starting claude-code-webui on port 8080..."
            
            # Start claude-code-webui
            exec claude-code-webui --port 8080 --host 0.0.0.0
        env:
        - name: DATABASE_URL
          value: "postgresql+asyncpg://test:test@localhost:5432/test"
        - name: TEST_DATABASE_URL  
          value: "postgresql+asyncpg://test:test@localhost:5432/test"
        - name: DEV_MODE
          value: "true"
        - name: HOME
          value: "/home/claude"
        volumeMounts:
        - name: workspace
          mountPath: /workspace
        - name: claude-home
          mountPath: /home/claude
        resources:
          requests:
            memory: "128Mi"
            cpu: "1"
          limits:
            memory: "4Gi"
            cpu: "2"
  volumeClaimTemplates:
  - metadata:
      name: workspace
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "shared-hostpath-storage"
      resources:
        requests:
          storage: 20Gi
  - metadata:
      name: claude-home
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "shared-hostpath-storage"
      resources:
        requests:
          storage: 5Gi
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "shared-hostpath-storage"
      resources:
        requests:
          storage: 5Gi