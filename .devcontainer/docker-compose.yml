services:
  # PostgreSQL database service
  postgres:
    image: pgvector/pgvector:0.8.0-pg17
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: test
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - devnet
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
  # Backend service container (runs both backend and frontend dev servers)
  backend:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    working_dir: /workspace/${WORKTREE_NAME:-main}
    user: "1001:1001"
    entrypoint: ["/usr/local/bin/setup-workspace.sh"]
    command: ["/bin/bash", "-c", "echo 'Waiting for PostgreSQL...' && for i in {1..30}; do if pg_isready -h postgres -U test; then echo 'PostgreSQL is ready!'; break; fi; sleep 1; done && mkdir -p /var/log/family-assistant && exec poe dev 2>&1 | tee /var/log/family-assistant/dev-server.log"]
    ports:
      - "8000:8000" # Backend API
      - "5173:5173" # Frontend dev server
    environment:
      - CONTAINER_ROLE=backend
      - DATABASE_URL=postgresql+asyncpg://test:test@postgres:5432/test
      - TEST_DATABASE_URL=postgresql+asyncpg://test:test@postgres:5432/test
      - DEV_MODE=true
      - HOME=/home/claude
      - UV_CACHE_DIR=/workspace/.cache/uv
      - UV_PYTHON_INSTALL_DIR=/workspace/.python-versions
      # Pass through any additional environment variables
      - CLAUDE_PROJECT_REPO=${CLAUDE_PROJECT_REPO:-https://github.com/werdnum/family-assistant.git}
      - CLAUDE_PROJECT_BRANCH=${CLAUDE_PROJECT_BRANCH:-}
      - WORKTREE_NAME=${WORKTREE_NAME:-main}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      # GitHub App Credentials
      - GITHUB_APP_ID=${GITHUB_APP_ID:-}
      - GITHUB_APP_INSTALLATION_ID=${GITHUB_APP_INSTALLATION_ID:-}
      - GITHUB_APP_PRIVATE_KEY_FILE=/run/secrets/github_app_private_key
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - BRAVE_API_KEY=${BRAVE_API_KEY:-}
      - HOMEASSISTANT_API_KEY=${HOMEASSISTANT_API_KEY:-}
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - REOLINK_CAMERAS=${REOLINK_CAMERAS:-}
      - DEBUG_LLM_MESSAGES=true
    volumes:
      # Mount workspace - you can change this to your desired host directory
      - ${WORKSPACE_DIR:-./workspace}:/workspace
      # Mount GitHub App private key if provided (defaults to dummy file to avoid mount errors)
      - ${GITHUB_APP_PRIVATE_KEY_PATH:-dummy-key}:/run/secrets/github_app_private_key:ro
      - dev-logs:/var/log/family-assistant
    networks:
      - devnet
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
  # Claude Code container (runs happy)
  claude:
    restart: always
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    working_dir: /workspace/${WORKTREE_NAME:-main}
    stdin_open: true
    tty: true
    user: "1001:1001"
    environment:
      - CONTAINER_ROLE=claude
      - DATABASE_URL=postgresql+asyncpg://test:test@postgres:5432/test
      - TEST_DATABASE_URL=postgresql+asyncpg://test:test@postgres:5432/test
      - DEV_MODE=true
      - HOME=/home/claude
      - UV_CACHE_DIR=/workspace/.cache/uv
      - UV_PYTHON_INSTALL_DIR=/workspace/.python-versions
      - PYTEST_PARALLELISM=${PYTEST_PARALLELISM:-4}
      # Oneshot mode environment variables
      - ONESHOT_MODE=${ONESHOT_MODE:-}
      - ONESHOT_STRICT_EXIT=${ONESHOT_STRICT_EXIT:-}
      - ONESHOT_TASK=${ONESHOT_TASK:-}
      - CLAUDE_PROJECT_REPO=${CLAUDE_PROJECT_REPO:-}
      - CLAUDE_PROJECT_BRANCH=${CLAUDE_PROJECT_BRANCH:-}
      - WORKTREE_NAME=${WORKTREE_NAME:-main}
      # Additional environment variables for family-assistant
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      # GitHub App Credentials
      - GITHUB_APP_ID=${GITHUB_APP_ID:-}
      - GITHUB_APP_INSTALLATION_ID=${GITHUB_APP_INSTALLATION_ID:-}
      - GITHUB_APP_PRIVATE_KEY_FILE=/run/secrets/github_app_private_key
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT:-}
    volumes:
      # Mount workspace - same as backend container
      - ${WORKSPACE_DIR:-./workspace}:/workspace
      # Mount GitHub App private key if provided (defaults to dummy file to avoid mount errors)
      - ${GITHUB_APP_PRIVATE_KEY_PATH:-dummy-key}:/run/secrets/github_app_private_key:ro
      # Mount Claude home directory - you can change this to your desired host directory
      - ${CLAUDE_HOME_DIR:-./claude-home}:/home/claude
      # Mount logs as read-only
      - dev-logs:/var/log/family-assistant:ro
    networks:
      - devnet
    deploy:
      resources:
        limits:
          cpus: '6.0'
          memory: 12G
  # Optional: Initialize workspace (run once to set up the repository)
  # Use: docker-compose run --rm init-workspace
  init-workspace:
    build: .
    profiles: ["init"]
    command: ["/usr/local/bin/setup-workspace.sh"]
    environment:
      - CLAUDE_PROJECT_REPO=${CLAUDE_PROJECT_REPO:-https://github.com/werdnum/family-assistant.git}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      # GitHub App Credentials
      - GITHUB_APP_ID=${GITHUB_APP_ID:-}
      - GITHUB_APP_INSTALLATION_ID=${GITHUB_APP_INSTALLATION_ID:-}
      - GITHUB_APP_PRIVATE_KEY_FILE=/run/secrets/github_app_private_key
      - UV_CACHE_DIR=/workspace/.cache/uv
      - UV_PYTHON_INSTALL_DIR=/workspace/.python-versions
    volumes:
      - ${WORKSPACE_DIR:-./workspace}:/workspace
      # Mount GitHub App private key if provided (defaults to dummy file to avoid mount errors)
      - ${GITHUB_APP_PRIVATE_KEY_PATH:-dummy-key}:/run/secrets/github_app_private_key:ro
      - ${CLAUDE_HOME_DIR:-./claude-home}:/home/claude
      - postgres-data:/var/lib/postgresql/data
    networks:
      - devnet
volumes:
  postgres-data:
  dev-logs:
networks:
  devnet:
    driver: bridge

