# CI-optimized version of the devcontainer
# Pre-installs project dependencies for faster CI runs
ARG BASE_IMAGE=ghcr.io/werdnum/family-assistant-devcontainer:latest
FROM ${BASE_IMAGE}

# Switch to root for setup
USER root

# Create cache directory with proper permissions
RUN mkdir -p /opt/uv-cache && chown claude:claude /opt/uv-cache

# The UV cache will be mounted at runtime and persist between builds
# No need to pre-populate - BuildKit cache mounts handle this efficiently

# Pre-install Playwright system dependencies (as root)
RUN npx --yes playwright install-deps chromium

# Create the browsers directory with correct permissions
RUN mkdir -p /home/claude/.cache/playwright-browsers && \
    chown -R claude:claude /home/claude/.cache

# Switch to claude user to install browsers in the correct location
USER claude
RUN npx --yes playwright install chromium

# Switch back to root for remaining setup
USER root

# Pre-build frontend assets for CI
# First copy only package files for better layer caching
COPY --chown=claude:claude frontend/package*.json /opt/frontend/

# Switch to claude user for npm operations
USER claude
WORKDIR /opt/frontend

# Install dependencies (cached when package.json doesn't change)
RUN npm ci --no-audit --no-fund

# Now copy the rest of the frontend source
COPY --chown=claude:claude frontend /opt/frontend/

# Build frontend and prepare dist assets
# Create the directory structure that Vite expects for build output
RUN mkdir -p /opt/src/family_assistant/static/dist && \
    npm run build && \
    # Create output directory for CI
    mkdir -p /opt/frontend-dist && \
    # The Vite build outputs to ../src/family_assistant/static/dist relative to /opt/frontend/
    # which is /opt/src/family_assistant/static/dist
    echo "=== Debug: Build output directory contents ===" && \
    ls -la /opt/src/family_assistant/static/dist/ && \
    # Copy all files including hidden directories like .vite/
    cp -r /opt/src/family_assistant/static/dist/. /opt/frontend-dist/ && \
    # Verify the copy worked and includes manifest
    echo "=== Debug: Frontend-dist contents after copy ===" && \
    ls -la /opt/frontend-dist/ && \
    echo "=== Debug: Checking for HistoryApp assets ===" && \
    (find /opt/frontend-dist -name "*HistoryApp*" -type f | head -5) && \
    echo "=== Debug: Manifest file check ===" && \
    (test -f /opt/frontend-dist/.vite/manifest.json && echo "✅ Manifest file found" || echo "❌ Manifest file missing") && \
    (test -f /opt/frontend-dist/router.html && echo "✅ Router HTML found" || echo "❌ Router HTML missing") && \
    # Clean up source files but keep node_modules for CI linting
    rm -rf src *.html *.js *.json

# The /opt/frontend directory now contains only node_modules
# which will be bind-mounted over during CI runs

# Set environment variables for CI mode
ENV UV_CACHE_DIR=/opt/uv-cache
ENV IS_CI_CONTAINER=true

# Switch back to claude user
USER claude
WORKDIR /workspace

# The entrypoint and cmd are inherited from the base image
