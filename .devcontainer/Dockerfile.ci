# CI-optimized version of the devcontainer
# Pre-installs project dependencies for faster CI runs
ARG BASE_IMAGE=ghcr.io/werdnum/family-assistant-devcontainer:latest
FROM ${BASE_IMAGE}

# Switch to root for setup
USER root

# Create cache directory with proper permissions
RUN mkdir -p /opt/uv-cache && chown claude:claude /opt/uv-cache

# Pre-download all dependencies to the uv cache
# This makes the actual installation much faster at runtime
WORKDIR /workspace
COPY pyproject.toml ./

RUN --mount=type=cache,target=/opt/uv-cache,uid=1000,gid=1000,sharing=locked \
    # Download all dependencies to populate the cache
    UV_CACHE_DIR=/opt/uv-cache uv pip download ".[dev]" && \
    UV_CACHE_DIR=/opt/uv-cache uv pip download poethepoet pytest-xdist && \
    # Clean up the workspace copy
    rm -f pyproject.toml

# Pre-install Playwright system dependencies and browser
RUN npx playwright install-deps chromium || true && \
    npx playwright install chromium || true

# Set environment variables for CI mode
ENV UV_CACHE_DIR=/opt/uv-cache
ENV IS_CI_CONTAINER=true

# Switch back to claude user
USER claude

# The entrypoint and cmd are inherited from the base image
