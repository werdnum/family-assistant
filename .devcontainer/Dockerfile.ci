# CI-optimized version of the devcontainer
# Pre-installs project dependencies for faster CI runs
ARG BASE_IMAGE=ghcr.io/werdnum/family-assistant-devcontainer:latest
FROM ${BASE_IMAGE}

# Switch to root for setup
USER root

# Create cache directory with proper permissions
RUN mkdir -p /opt/uv-cache && chown claude:claude /opt/uv-cache

# The UV cache will be mounted at runtime and persist between builds
# No need to pre-populate - BuildKit cache mounts handle this efficiently

# Pre-install Playwright system dependencies and browser
RUN npx playwright install-deps chromium || true && \
    npx playwright install chromium || true

# Pre-build frontend assets for CI
# First copy only package files for better layer caching
COPY --chown=claude:claude frontend/package*.json /opt/frontend/

# Switch to claude user for npm operations
USER claude
WORKDIR /opt/frontend

# Install dependencies (cached when package.json doesn't change)
RUN npm ci --no-audit --no-fund

# Now copy the rest of the frontend source
COPY --chown=claude:claude frontend /opt/frontend/

# Build frontend and prepare dist assets
RUN npm run build && \
    # Copy built assets to a known location
    mkdir -p /opt/frontend-dist && \
    cp -r ../src/family_assistant/static/dist/* /opt/frontend-dist/ && \
    # Also copy the .vite directory which contains the manifest
    cp -r ../src/family_assistant/static/dist/.vite /opt/frontend-dist/.vite && \
    # Clean up source files but keep node_modules for CI linting
    rm -rf src *.html *.js *.json

# The /opt/frontend directory now contains only node_modules
# which will be bind-mounted over during CI runs

# Set environment variables for CI mode
ENV UV_CACHE_DIR=/opt/uv-cache
ENV IS_CI_CONTAINER=true

# Switch back to claude user
USER claude
WORKDIR /workspace

# The entrypoint and cmd are inherited from the base image
