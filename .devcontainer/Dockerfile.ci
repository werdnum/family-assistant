# CI-optimized version of the devcontainer
# Pre-installs project dependencies for faster CI runs
ARG BASE_IMAGE=ghcr.io/werdnum/family-assistant-devcontainer:latest
FROM ${BASE_IMAGE}

# Switch to root for setup
USER root

# Create cache directory with proper permissions
RUN mkdir -p /opt/uv-cache && chown claude:claude /opt/uv-cache

# The UV cache will be mounted at runtime and persist between builds
# No need to pre-populate - BuildKit cache mounts handle this efficiently

# Pre-install Playwright system dependencies and browser
RUN npx playwright install-deps chromium || true && \
    npx playwright install chromium || true

# Set environment variables for CI mode
ENV UV_CACHE_DIR=/opt/uv-cache
ENV IS_CI_CONTAINER=true

# Switch back to claude user
USER claude

# The entrypoint and cmd are inherited from the base image
