# CI-optimized version of the devcontainer with multi-stage builds
# Pre-installs project dependencies for faster CI runs

ARG BASE_IMAGE=ghcr.io/werdnum/family-assistant:devcontainer-base-latest

# Frontend build stage - runs independently for better parallelization
FROM ${BASE_IMAGE} AS frontend-builder

# Switch to claude user for frontend operations
USER claude
WORKDIR /opt/frontend

# Copy only package files first for better caching (from project root context)
COPY --chown=claude:claude frontend/package*.json ./

# Install frontend dependencies with cache mount
RUN --mount=type=cache,target=/home/claude/.npm,sharing=locked,uid=1001,gid=1001 \
    npm ci --no-audit --no-fund

# Copy frontend source (from project root context)
COPY --chown=claude:claude frontend/ ./
# Create the output directory structure that Vite expects
RUN mkdir -p /opt/src/family_assistant/static && \
    npm run build && \
    # Build outputs to ../src/family_assistant/static/dist relative to /opt/frontend
    # Copy built assets to a clean output directory for the final stage
    mkdir -p /tmp/frontend-dist && \
    cp -r /opt/src/family_assistant/static/dist/. /tmp/frontend-dist/

# Backend preparation stage - pre-install Python dependencies for CI
FROM ${BASE_IMAGE} AS backend-prep

USER root
# Create cache directory with proper permissions
RUN mkdir -p /opt/uv-cache && chown claude:claude /opt/uv-cache

USER claude
WORKDIR /tmp/build

# Copy project files needed for dependency installation
COPY --chown=claude:claude pyproject.toml uv.lock ./
COPY --chown=claude:claude src ./src

# Install project dependencies into the base /venv
RUN --mount=type=cache,target=/home/claude/.cache/uv,sharing=locked,uid=1001,gid=1001 \
    . /venv/bin/activate && \
    uv pip install -e '.[dev]'

# Final stage - combines frontend and backend
FROM ${BASE_IMAGE} AS final

# Switch to root for initial setup
USER root

# Create cache directory with proper permissions
RUN mkdir -p /opt/uv-cache && chown claude:claude /opt/uv-cache

# Copy pre-built frontend assets from frontend stage
COPY --from=frontend-builder --chown=claude:claude /tmp/frontend-dist /opt/frontend-dist/

# Copy Python dependencies from backend-prep stage
COPY --from=backend-prep --chown=claude:claude /venv /venv

# Pre-build frontend node_modules for linting (separate from build artifacts)
# Copy from project root context
COPY --chown=claude:claude frontend/package*.json /opt/frontend/
RUN --mount=type=cache,target=/root/.npm,sharing=locked \
    cd /opt/frontend && \
    npm ci --no-audit --no-fund && \
    chown -R claude:claude /opt/frontend

# The /opt/frontend directory now contains only node_modules for CI linting
# The /opt/frontend-dist directory contains the built frontend assets

# Set environment variables for CI mode
ENV UV_CACHE_DIR=/opt/uv-cache
ENV IS_CI_CONTAINER=true

# Switch to claude user
USER claude
WORKDIR /workspace

# The entrypoint and cmd are inherited from the base image
