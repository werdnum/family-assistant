# Bugs for 2025-06-10

## Document indexing issues

- Loading the vector search UI is broken - using `json_each` instead of `jsonb_each` - `sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: function json_each(jsonb) does not exist`
- I don't think the document ID is available in the search results. That's silly - it's necessary for viewing the document. Put "Document ID (for retrieving full content)" or something in the tool output to hint to the LLM that it should retrieve the full document. Maybe put the metadata in there too.

## Error handling

- We don't retry BadRequestErrors (or fallback). I think this is wrong - one common cause of bugs is when one provider (e.g. Gemini) fails because it doesn't like some aspect of the input.
- When we get an error, we don't include the error message in message history. This means that when we send a message later, the bot doesn't see that it replied to the prior messages and replies to all of them at once.
- This also applies for messages sent by send_message_to_user or whatever it is. Can't see it in the history.

## Misc

- Sometimes the bot replies a little, then does a tool call, then replies a bit more. We only send the final response. This is confusing for the user because the user doesn't see things the bot thought it already sent. Maybe cleanest to strip out the text from the messages with tool calls?
- The bot sometimes adds things to the calendar that are already there. We should fix this with system prompt changes or something else.
- Scheduled messages don't seem to have the forced reply flag set. This means that if you ask for a reminder, then wait a few minutes and get the reminder, you reply to the bot's original reply and not the reminder and the bot gets confused.
- "Please confirm you want to delete the event: Event: Event details not found." -- calendar event fetching for this seems broken. Maybe needs a test?
- The tool parameters JSON viewer in the message history UI is broken (again, I think). Some initialization issue?
