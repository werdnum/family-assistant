{% extends "base.html.j2" %}

{% block title_header %}Scheduled Tasks{% endblock %}

{% block main_content %}
    <!-- Filter Form -->
    <form id="filter-form" class="filter-form" method="get" action="{{ url_for('ui_list_tasks') }}">
        <div class="filter-row">
            <div class="filter-group">
                <label for="status-filter">Status:</label>
                <select id="status-filter" name="status">
                    <option value="">All</option>
                    <option value="pending" {% if request.query_params.get('status') == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="processing" {% if request.query_params.get('status') == 'processing' %}selected{% endif %}>Processing</option>
                    <option value="done" {% if request.query_params.get('status') == 'done' %}selected{% endif %}>Done</option>
                    <option value="failed" {% if request.query_params.get('status') == 'failed' %}selected{% endif %}>Failed</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="task-type-filter">Task Type:</label>
                <input type="text" id="task-type-filter" name="task_type" 
                       value="{{ request.query_params.get('task_type', '') }}" 
                       placeholder="e.g., llm_callback"
                       list="task-types-list">
                <datalist id="task-types-list">
                    {% for task_type in task_types %}
                    <option value="{{ task_type }}">
                    {% endfor %}
                </datalist>
            </div>
            
            <div class="filter-group">
                <label for="date-from-filter">From:</label>
                <input type="datetime-local" id="date-from-filter" name="date_from" 
                       value="{{ request.query_params.get('date_from', '') }}">
            </div>
            
            <div class="filter-group">
                <label for="date-to-filter">To:</label>
                <input type="datetime-local" id="date-to-filter" name="date_to" 
                       value="{{ request.query_params.get('date_to', '') }}">
            </div>
            
            <div class="filter-group">
                <label for="sort-filter">Sort:</label>
                <select id="sort-filter" name="sort">
                    <option value="asc" {% if request.query_params.get('sort') == 'asc' %}selected{% endif %}>Oldest First</option>
                    <option value="desc" {% if request.query_params.get('sort', 'desc') == 'desc' %}selected{% endif %}>Newest First</option>
                </select>
            </div>
        </div>
        
        <div class="filter-actions">
            <button type="submit" class="button-primary">Apply Filters</button>
            <a href="{{ url_for('ui_list_tasks') }}" class="button-secondary">Clear Filters</a>
        </div>
    </form>
    
    <div class="tasks-summary">
        <p>Showing {{ tasks|length }} task{% if tasks|length != 1 %}s{% endif %}
        {% if active_filters %}
            with filters:
            {% if request.query_params.get('status') %}
                <span class="filter-tag">Status: {{ request.query_params.get('status') }}</span>
            {% endif %}
            {% if request.query_params.get('task_type') %}
                <span class="filter-tag">Type: {{ request.query_params.get('task_type') }}</span>
            {% endif %}
            {% if request.query_params.get('date_from') or request.query_params.get('date_to') %}
                <span class="filter-tag">Date Range</span>
            {% endif %}
        {% endif %}
        </p>
    </div>

    {% if tasks %}
    <div class="tasks-list">
        {% for task in tasks %}
        <article class="task-card status-{{ task.status }}">
            <div class="task-detail"><span class="task-label">Task ID:</span> <span class="task-value task-id">{{ task.task_id }}</span></div>
            <div class="task-detail"><span class="task-label">Type:</span> <span class="task-value">{{ task.task_type }}</span></div>
            <div class="task-detail"><span class="task-label">Status:</span> <span class="task-value task-status">{{ task.status }}</span></div>
            <div class="task-detail"><span class="task-label">Scheduled:</span> <span class="task-value">{{ task.scheduled_at.strftime('%Y-%m-%d %H:%M:%S %Z') if task.scheduled_at else 'Immediate' }}</span></div>
            <div class="task-detail"><span class="task-label">Created:</span> <span class="task-value">{{ task.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') if task.created_at else 'N/A' }}</span></div>
            <div class="task-detail"><span class="task-label">Retries:</span> <span class="task-value">{{ task.retry_count }} / {{ task.max_retries }}</span></div>
            {% if task.recurrence_rule %}
            <div class="task-detail"><span class="task-label">Recurrence:</span> <span class="task-value task-recurrence">{{ task.recurrence_rule }}</span></div>
            <div class="task-detail"><span class="task-label">Original Task ID:</span> <span class="task-value task-id">{{ task.original_task_id }}</span></div>
            {% endif %}
            <div class="task-detail task-payload">
                <span class="task-label">Payload:</span>
                <div id="payload-{{ task.id }}" class="json-editor-container">{{ 'None' if task.payload is none }}</div>
            </div>
             <div class="task-detail task-error">
                <span class="task-label">Last Error:</span>
                <pre>{{ task.error if task.error else 'None' }}</pre>
            </div>
             <div class="task-detail task-internal-id"><span class="task-label">Internal ID:</span> <span class="task-value">{{ task.id }}</span></div>
            {% if task.status == 'failed' or (task.status == 'pending' and task.retry_count >= task.max_retries) %}
            <div class="task-actions" style="margin-top: 10px;">
                <form action="{{ url_for('ui_retry_task', internal_task_id=task.id) }}" method="post" style="display: inline;">
                    <button type="submit" class="button-retry">Retry Manually</button>
                </form>
            </div>
            {% endif %}
        </article>
        {% endfor %}
    </div>
    {% else %}
        <p>No tasks found.</p>
    {% endif %}
{% endblock %}

{% block scripts_extra %}
<!-- Load tasks filter script -->
<script src="{{ url_for('static', path='js/tasks_filters.js') }}"></script>

<!-- Load vanilla-jsoneditor -->
<script type="module">
    import { createJSONEditor } from 'https://unpkg.com/vanilla-jsoneditor/standalone.js';

    function initializeEditor(targetId, jsonData) {
        const target = document.getElementById(targetId);
        if (!target || jsonData === null || jsonData === undefined) {
            if(target && (jsonData === null || jsonData === undefined)) {
                 target.textContent = 'None';
            } else if (!target) {
                 console.error(`Element with ID ${targetId} not found.`);
            }
            return;
        }

        let content = { json: jsonData };

        try {
            target.textContent = ''; // Clear the target before initializing the editor
            new createJSONEditor({
                target: target,
                props: {
                    content,
                    readOnly: true,
                    mainMenuBar: false,
                    navigationBar: false,
                    statusBar: false,
                    mode: 'tree'
                }
            });
        } catch (error) {
             console.error(`Failed to initialize JSONEditor for ${targetId}:`, error);
             target.innerHTML = `<pre>${JSON.stringify(jsonData, null, 2)}</pre>`;
        }
    }

    {% for task in tasks %}
        initializeEditor('payload-{{ task.id }}', {{ task.payload | tojson | safe if task.payload is not none else 'null' }});
    {% endfor %}
</script>
{% endblock %}
