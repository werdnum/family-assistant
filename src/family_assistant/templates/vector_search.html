{% extends "base.html" %}

{% block title_header %}Vector Search Debugger{% endblock %}

{% block head_extra %}
    <style>
        .form-grid { display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center; margin-bottom: 1.5rem;}
        .form-grid label { font-weight: bold; }
        .form-grid .full-width { grid-column: 1 / -1; }
        .checkbox-group label, .radio-group label { display: inline-block; margin-right: 1rem; font-weight: normal;}
        .checkbox-group input, .radio-group input { margin-right: 0.3rem; }
        .results-table th, .results-table td { text-align: left; padding: 0.5rem; vertical-align: top; }
        .results-table pre { white-space: pre-wrap; word-break: break-all; margin: 0; font-size: 0.9em; }
        .error-message { color: red; font-weight: bold; margin-bottom: 1rem; border: 1px solid red; padding: 0.5rem; }
        .metadata-cell { max-width: 300px; }
        .filter-row { display: contents; }
        .filter-row > * { margin-bottom: 0.5rem; }
        .remove-filter-btn { background-color: #ffcccc; border: 1px solid red; color: red; padding: 0.2rem 0.5rem; cursor: pointer; }
        .results-list { list-style: none; padding: 0; }
        .result-card { border: 1px solid #ccc; border-radius: 5px; margin-bottom: 1.5rem; padding: 1rem; background-color: var(--bg-secondary); }
        .result-card h4 { margin-top: 0; margin-bottom: 0.5rem; }
        .result-card .content-snippet { background-color: var(--bg); padding: 0.8rem; border-radius: 3px; margin: 0.8rem 0; font-size: 0.95em; white-space: pre-wrap; word-break: break-word; }
        .result-card .metadata-display { background-color: var(--bg); padding: 0.8rem; border-radius: 3px; margin: 0.8rem 0; font-size: 0.85em; white-space: pre-wrap; word-break: break-word; max-height: 200px; overflow-y: auto; }
        .result-card .source-info { font-size: 0.9em; color: var(--text-light); margin-bottom: 0.8rem; }
        .result-card .debug-details summary { font-size: 0.9em; color: var(--text-light); cursor: pointer; margin-top: 1rem; }
        .result-card .debug-details div { font-size: 0.85em; color: var(--text-muted); background-color: var(--bg); padding: 0.5rem; border-radius: 3px; margin-top: 0.5rem; }
        .result-card .debug-details span { display: inline-block; min-width: 100px; font-weight: bold; }
    </style>
{% endblock %}

{% block main_content %}
    {% if error %}
    <p class="error-message">Error: {{ error }}</p>
    {% endif %}

    <form action="{{ request.app.url_path_for('ui_vector_search') }}" method="post">
        <div class="form-grid">
            <label for="semantic_query">Search Query:</label>
            <textarea name="semantic_query" id="semantic_query" rows="3" placeholder="Describe what you're looking for...">{{ search_params.semantic_query or '' }}</textarea>

            <label for="embedding_model">Embedding Model:</label>
            <select name="embedding_model" id="embedding_model" required>
                <option value="">-- Select Model --</option>
                {% for model in distinct_models %}
                <option value="{{ model }}" {% if distinct_models | length == 1 or search_params.embedding_model == model %}selected{% endif %}>{{ model }}</option>
                {% else %}
                <option value="" disabled>No models found in DB</option>
                {% endfor %}
            </select>

             <label for="source_types" class="full-width">Filter by Document Source Type(s):</label>
            <div class="checkbox-group full-width">
                 {% for stype in distinct_source_types %}
                 <label>
                     <input type="checkbox" name="source_types" value="{{ stype }}" {% if stype in search_params.source_types %}checked{% endif %}>
                     {{ stype }}
                 </label>
                 {% else %}
                 <span>(No source types found in DB)</span>
                 {% endfor %}
            </div>

            <label for="title_like">Title Contains (Case-Insensitive):</label>
            <input type="text" name="title_like" id="title_like" value="{{ search_params.title_like or '' }}">

            <label for="created_after">Created After:</label>
            <input type="date" name="created_after" id="created_after" value="{{ search_params.created_after or '' }}">

            <label for="created_before">Created Before:</label>
            <input type="date" name="created_before" id="created_before" value="{{ search_params.created_after or '' }}">

            <label class="full-width">Metadata Filters (AND):</label>
            <div id="metadata-filters-container" class="full-width">
                {% for i in range(search_params.metadata_keys | length) %}
                <div class="filter-row">
                    <select name="metadata_keys" required>
                        <option value="">-- Select Key --</option>
                        {% for key in distinct_metadata_keys %}
                        <option value="{{ key }}" {% if search_params.metadata_keys[i] == key %}selected{% endif %}>{{ key }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" name="metadata_values" value="{{ search_params.metadata_values[i] or '' }}" placeholder="Value" required>
                    <button type="button" class="remove-filter-btn" onclick="removeFilter(this)">Remove</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-filter-btn" class="full-width" style="grid-column: 1 / -1; margin-top: 0.5rem;">Add Metadata Filter</button>

            <label for="limit">Result Limit:</label>
            <input type="number" name="limit" id="limit" value="{{ search_params.limit or 10 }}" min="1" max="100">

            <details class="full-width" style="margin-top: 1rem; border: 1px solid #ccc; padding: 0.5rem;">
                <summary style="cursor: pointer; font-weight: bold;">Advanced Options</summary>
                <div class="form-grid" style="margin-top: 1rem;">
                    <label for="search_type" class="full-width">Search Type:</label>
                    <div class="radio-group full-width">
                        <label><input type="radio" name="search_type" value="hybrid" {% if search_params.search_type == 'hybrid' or not search_params.search_type %}checked{% endif %}> Hybrid (RRF)</label>
                        <label><input type="radio" name="search_type" value="semantic" {% if search_params.search_type == 'semantic' %}checked{% endif %}> Semantic Only</label>
                        <label><input type="radio" name="search_type" value="keyword" {% if search_params.search_type == 'keyword' %}checked{% endif %}> Keyword Only</label>
                    </div>

                    <label for="keywords">Keywords (for FTS):</label>
                    <input type="text" name="keywords" id="keywords" value="{{ search_params.keywords or '' }}" placeholder="Explicit keywords for text matching...">

                    <label for="embedding_types" class="full-width">Filter by Embedding Type(s):</label>
                    <div class="checkbox-group full-width">
                         {% for etype in distinct_types %}
                         <label>
                             <input type="checkbox" name="embedding_types" value="{{ etype }}" {% if etype in search_params.embedding_types %}checked{% endif %}>
                             {{ etype }}
                         </label>
                         {% else %}
                         <span>(No embedding types found in DB)</span>
                         {% endfor %}
                    </div>

                    <label for="rrf_k">RRF k (for Hybrid):</label>
                    <input type="number" name="rrf_k" id="rrf_k" value="{{ search_params.rrf_k or 60 }}" min="1">
                </div>
            </details>
            <button type="submit" class="full-width" style="margin-top: 1rem;">Search</button>
        </div>
    </form>

    <hr>

    <h2>Results</h2>
    {% if results is not none %}
        {% if results %}
        <p>Found {{ results|length }} document(s).</p>
        <div class="results-list">
            {% for doc_result in results %}
            <article class="result-card">
                <h4>
                    {% if doc_result.source_uri %}
                    <a href="{{ doc_result.source_uri }}" target="_blank" rel="noopener noreferrer">{{ doc_result.title or 'Untitled Document' }}</a>
                    {% else %}
                    {{ doc_result.title or 'Untitled Document' }}
                    {% endif %}
                </h4>
                <div class="source-info">
                    Source: {{ doc_result.source_type }} | Created: {{ doc_result.created_at.strftime('%Y-%m-%d %H:%M') if doc_result.created_at else 'N/A' }} <br>
                    <a href="{{ request.app.url_path_for('ui_document_detail', document_id=doc_result.document_id) }}">View Full Document Details (ID: {{ doc_result.document_id }})</a>
                </div>

                {% if doc_result.doc_metadata %}
                 <details>
                    <summary style="font-weight: bold; cursor: pointer; margin-bottom: 0.3rem;">Document Metadata</summary>
                    <div id="doc-metadata-{{ doc_result.document_id }}" class="json-editor-container metadata-display"></div>
                 </details>
                {% endif %}

                <details class="debug-details">
                    <summary>Document Scores (Best of Snippets)</summary>
                    <div>
                        <span>Best RRF Score:</span> {{ "%.4f"|format(doc_result.best_rrf_score) if doc_result.best_rrf_score != -float('inf') else 'N/A' }}<br>
                        <span>Best FTS Score:</span> {{ "%.4f"|format(doc_result.best_fts_score) if doc_result.best_fts_score != -float('inf') else 'N/A' }}<br>
                        <span>Min Distance:</span> {{ "%.4f"|format(doc_result.min_distance) if doc_result.min_distance != float('inf') else 'N/A' }}
                    </div>
                </details>

                {% if doc_result.snippets %}
                <h5 style="margin-top: 1rem; margin-bottom: 0.5rem;">Matching Snippets ({{ doc_result.snippets|length }}):</h5>
                {% for snippet in doc_result.snippets %}
                <div class="snippet-card" style="border: 1px dashed #ddd; padding: 0.8rem; margin-bottom: 0.8rem; background-color: var(--bg);">
                    {% if snippet.embedding_source_content %}
                    <details open>
                        <summary style="font-weight: bold; cursor: pointer; margin-bottom: 0.3rem;">Snippet Content (Chunk {{ snippet.chunk_index }})</summary>
                        <pre class="content-snippet">{{ snippet.embedding_source_content }}</pre>
                    </details>
                    {% endif %}

                    {% if snippet.embedding_metadata %}
                    <details>
                        <summary style="font-weight: bold; cursor: pointer; margin-bottom: 0.3rem;">Snippet Metadata</summary>
                        <div id="snippet-metadata-{{ snippet.embedding_id }}" class="json-editor-container metadata-display" style="font-size: 0.9em;"></div>
                    </details>
                    {% endif %}

                    <details class="debug-details">
                        <summary>Snippet Details & Scores</summary>
                        <div>
                            <span>Embedding ID:</span> {{ snippet.embedding_id }}<br>
                            <span>Embedding Type:</span> {{ snippet.embedding_type }}<br>
                            <span>Chunk Index:</span> {{ snippet.chunk_index }}<br>
                            <span>Distance:</span> {{ "%.4f"|format(snippet.distance) if snippet.distance is not none else 'N/A' }}<br>
                            <span>FTS Score:</span> {{ "%.4f"|format(snippet.fts_score) if snippet.fts_score is not none else 'N/A' }}<br>
                            <span>RRF Score:</span> {{ "%.4f"|format(snippet.rrf_score) if snippet.rrf_score is not none else 'N/A' }}
                        </div>
                    </details>
                </div>
                {% endfor %}
                {% endif %}
            </article>
            {% endfor %}
        </div>
        {% else %}
        <p>No results found for the given criteria.</p>
        {% endif %}
    {% else %}
        <p>Perform a search to see results.</p>
    {% endif %}
{% endblock %}

{% block scripts_extra %}
<script>
    const filtersContainer = document.getElementById('metadata-filters-container');
    const addFilterBtn = document.getElementById('add-filter-btn');
    const distinctKeys = {{ distinct_metadata_keys | tojson | safe }};

    function createFilterRow() {
        const div = document.createElement('div');
        div.className = 'filter-row';

        const keySelect = document.createElement('select');
        keySelect.name = 'metadata_keys';
        keySelect.required = true;
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Select Key --';
        keySelect.appendChild(defaultOption);
        distinctKeys.forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key;
            keySelect.appendChild(option);
        });

        const valueInput = document.createElement('input');
        valueInput.type = 'text';
        valueInput.name = 'metadata_values';
        valueInput.placeholder = 'Value';
        valueInput.required = true;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Remove';
        removeBtn.className = 'remove-filter-btn';
        removeBtn.onclick = function() { removeFilter(this); };

        div.appendChild(keySelect);
        div.appendChild(valueInput);
        div.appendChild(removeBtn);

        return div;
    }

    function removeFilter(button) {
        button.closest('.filter-row').remove();
    }

    addFilterBtn.addEventListener('click', () => {
        filtersContainer.appendChild(createFilterRow());
    });
</script>

<script type="module">
    import { createJSONEditor } from 'https://unpkg.com/vanilla-jsoneditor/standalone.js';

    function initializeJsonEditorForResult(targetId, jsonData) {
        const target = document.getElementById(targetId);
        if (!target || !jsonData) {
             if (!target) console.error(`Element with ID ${targetId} not found.`);
            return;
        }

        let content = { json: jsonData };

        try {
            new createJSONEditor({
                target: target,
                props: {
                    content,
                    readOnly: true,
                    mainMenuBar: false,
                    navigationBar: false,
                    statusBar: false,
                    mode: 'tree'
                }
            });
        } catch (error) {
             console.error(`Failed to initialize JSONEditor for ${targetId}:`, error);
             target.innerHTML = `<pre>${JSON.stringify(jsonData, null, 2)}</pre>`;
        }
    }

    {% if results %}
    {% for doc_result in results %}
        {% if doc_result.doc_metadata %}
        initializeJsonEditorForResult('doc-metadata-{{ doc_result.document_id }}', {{ doc_result.doc_metadata | tojson | safe }});
        {% endif %}
        {% if doc_result.snippets %}
            {% for snippet in doc_result.snippets %}
                {% if snippet.embedding_metadata %}
                initializeJsonEditorForResult('snippet-metadata-{{ snippet.embedding_id }}', {{ snippet.embedding_metadata | tojson | safe }});
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}
    {% endif %}
</script>
{% endblock %}
