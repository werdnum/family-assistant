{% extends "base.html" %}

{% block title_header %}Scheduled Tasks{% endblock %}

{% block main_content %}
    {% if tasks %}
    <div class="tasks-list">
        {% for task in tasks %}
        <article class="task-card status-{{ task.status }}">
            <div class="task-detail"><span class="task-label">Task ID:</span> <span class="task-value task-id">{{ task.task_id }}</span></div>
            <div class="task-detail"><span class="task-label">Type:</span> <span class="task-value">{{ task.task_type }}</span></div>
            <div class="task-detail"><span class="task-label">Status:</span> <span class="task-value task-status">{{ task.status }}</span></div>
            <div class="task-detail"><span class="task-label">Scheduled:</span> <span class="task-value">{{ task.scheduled_at.strftime('%Y-%m-%d %H:%M:%S %Z') if task.scheduled_at else 'Immediate' }}</span></div>
            <div class="task-detail"><span class="task-label">Created:</span> <span class="task-value">{{ task.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') if task.created_at else 'N/A' }}</span></div>
            <div class="task-detail"><span class="task-label">Retries:</span> <span class="task-value">{{ task.retry_count }} / {{ task.max_retries }}</span></div>
            {% if task.recurrence_rule %}
            <div class="task-detail"><span class="task-label">Recurrence:</span> <span class="task-value task-recurrence">{{ task.recurrence_rule }}</span></div>
            <div class="task-detail"><span class="task-label">Original Task ID:</span> <span class="task-value task-id">{{ task.original_task_id }}</span></div>
            {% endif %}
            <div class="task-detail task-payload">
                <span class="task-label">Payload:</span>
                <div id="payload-{{ task.id }}" class="json-editor-container">{{ 'None' if task.payload is none }}</div>
            </div>
             <div class="task-detail task-error">
                <span class="task-label">Last Error:</span>
                <pre>{{ task.error if task.error else 'None' }}</pre>
            </div>
             <div class="task-detail task-internal-id"><span class="task-label">Internal ID:</span> <span class="task-value">{{ task.id }}</span></div>
            {% if task.status == 'failed' or (task.status == 'pending' and task.retry_count >= task.max_retries) %}
            <div class="task-actions" style="margin-top: 10px;">
                <form action="{{ url_for('ui_retry_task', internal_task_id=task.id) }}" method="post" style="display: inline;">
                    <button type="submit" class="button-retry">Retry Manually</button>
                </form>
            </div>
            {% endif %}
        </article>
        {% endfor %}
    </div>
    {% else %}
        <p>No tasks found.</p>
    {% endif %}
{% endblock %}

{% block scripts_extra %}
<!-- Load vanilla-jsoneditor -->
<script type="module">
    import { createJSONEditor } from 'https://unpkg.com/vanilla-jsoneditor/standalone.js';

    function initializeEditor(targetId, jsonData) {
        const target = document.getElementById(targetId);
        if (!target || jsonData === null || jsonData === undefined) {
            if(target && (jsonData === null || jsonData === undefined)) {
                 target.textContent = 'None';
            } else if (!target) {
                 console.error(`Element with ID ${targetId} not found.`);
            }
            return;
        }

        let content = { json: jsonData };

        try {
            new createJSONEditor({
                target: target,
                props: {
                    content,
                    readOnly: true,
                    mainMenuBar: false,
                    navigationBar: false,
                    statusBar: false,
                    mode: 'tree'
                }
            });
            target.textContent = '';
        } catch (error) {
             console.error(`Failed to initialize JSONEditor for ${targetId}:`, error);
             target.innerHTML = `<pre>${JSON.stringify(jsonData, null, 2)}</pre>`;
        }
    }

    {% for task in tasks %}
        initializeEditor('payload-{{ task.id }}', {{ task.payload | tojson | safe if task.payload is not none else 'null' }});
    {% endfor %}
</script>
{% endblock %}
