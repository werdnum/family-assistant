{% extends "base.html.j2" %}

{% block title %}Event Listener: {{ listener.name }}{% endblock %}

{% block content %}
<h1>{{ listener.action_icon }} {{ listener.name }}</h1>

<nav style="margin-bottom: 2rem;">
    <a href="/event-listeners">‚Üê Back to Event Listeners</a>
</nav>

<!-- Configuration Section -->
<section>
    <h2>Configuration</h2>
    <dl>
        <dt>ID:</dt>
        <dd>{{ listener.id }}</dd>
        
        <dt>Description:</dt>
        <dd>{{ listener.description or "No description provided" }}</dd>
        
        <dt>Source Type:</dt>
        <dd><span style="text-transform: capitalize;">{{ listener.source_id.replace('_', ' ') }}</span></dd>
        
        <dt>Action Type:</dt>
        <dd>
            {% if listener.action_type == "wake_llm" %}
                ü§ñ LLM Callback
            {% else %}
                üìú Script Execution
            {% endif %}
        </dd>
        
        <dt>Status:</dt>
        <dd>
            {% if listener.enabled %}
                <span style="color: var(--accent);">‚úì Enabled</span>
            {% else %}
                <span style="color: var(--text-light);">‚úó Disabled</span>
            {% endif %}
            {% if listener.one_time %}
                (One-time listener)
            {% endif %}
        </dd>
        
        <dt>Created:</dt>
        <dd>{{ listener.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') if listener.created_at else 'N/A' }}</dd>
        
        <dt>Conversation ID:</dt>
        <dd><code>{{ listener.conversation_id }}</code></dd>
        
        <dt>Interface Type:</dt>
        <dd>{{ listener.interface_type }}</dd>
    </dl>
</section>

<!-- Match Conditions -->
<section style="margin-top: 2rem;">
    <h2>Match Conditions</h2>
    <p style="color: var(--text-light);">Events must match all of these conditions to trigger this listener.</p>
    {% if listener.formatted_conditions %}
    <ul>
        {% for condition in listener.formatted_conditions %}
        <li><code>{{ condition }}</code></li>
        {% endfor %}
    </ul>
    {% else %}
    <p><em>No match conditions defined (matches all events from source).</em></p>
    {% endif %}
</section>

<!-- Action Configuration -->
<section style="margin-top: 2rem;">
    {% if listener.action_type == "script" %}
    <h2>Script Code</h2>
    {% if listener.action_config and listener.action_config.script_code %}
    <div style="background-color: var(--bg-secondary); padding: 1rem; border-radius: 8px; overflow-x: auto;">
        <pre><code class="language-python">{{ listener.action_config.script_code }}</code></pre>
    </div>
    <p style="margin-top: 1rem;">
        <strong>Timeout:</strong> {{ listener.action_config.timeout or 600 }} seconds
    </p>
    {% else %}
    <p><em>No script code defined.</em></p>
    {% endif %}
    
    {% else %}
    <h2>LLM Callback Configuration</h2>
    {% if listener.action_config %}
    <dl>
        <dt>Callback Prompt:</dt>
        <dd>
            {% if listener.action_config.llm_callback_prompt %}
            <pre style="background-color: var(--bg-secondary); padding: 1rem; border-radius: 8px;">{{ listener.action_config.llm_callback_prompt }}</pre>
            {% else %}
            <em>Default prompt will be used</em>
            {% endif %}
        </dd>
    </dl>
    {% endif %}
    {% endif %}
</section>

<!-- Execution Statistics -->
<section style="margin-top: 2rem;">
    <h2>Execution Statistics</h2>
    <dl>
        <dt>Total Executions:</dt>
        <dd>{{ stats.total_executions }}</dd>
        
        <dt>Today's Executions:</dt>
        <dd>
            {{ stats.daily_executions }} / {{ stats.daily_limit }}
            {% if stats.daily_executions >= stats.daily_limit %}
                <span style="color: orange;">(Rate limited)</span>
            {% endif %}
        </dd>
        
        <dt>Last Execution:</dt>
        <dd>
            {% if stats.last_execution_at %}
                {{ stats.last_execution_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}
            {% else %}
                Never
            {% endif %}
        </dd>
    </dl>
</section>

<!-- Recent Executions (for Script listeners) -->
{% if listener.action_type == "script" and task_executions %}
<section style="margin-top: 2rem;">
    <h2>Recent Script Executions</h2>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Created</th>
                    <th>Status</th>
                    <th>Error</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for task in task_executions %}
                <tr>
                    <td>{{ task.created_at.strftime('%Y-%m-%d %H:%M:%S') if task.created_at else 'N/A' }}</td>
                    <td>
                        {% if task.status == "done" %}
                            <span style="color: green;">‚úì Success</span>
                        {% elif task.status == "failed" %}
                            <span style="color: red;">‚úó Failed</span>
                        {% elif task.status == "processing" %}
                            <span style="color: orange;">‚ü≥ Processing</span>
                        {% else %}
                            <span style="color: var(--text-light);">‚è≥ Pending</span>
                        {% endif %}
                        {% if task.retry_count > 0 %}
                            <br><small>Retry {{ task.retry_count }}/{{ task.max_retries }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if task.error %}
                            <code style="font-size: 0.9em; color: red;">{{ task.error[:100] }}{% if task.error|length > 100 %}...{% endif %}</code>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <a href="/tasks?internal_id={{ task.id }}">View Task</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if task_total > 20 %}
    <p style="margin-top: 1rem;">Showing most recent 20 of {{ task_total }} executions. <a href="/tasks?task_type=script_execution&search=listener_{{ listener.id }}">View all in Tasks</a></p>
    {% endif %}
</section>
{% endif %}

<!-- Recent Events -->
{% if stats.recent_events %}
<section style="margin-top: 2rem;">
    <h2>Recent Events That Triggered This Listener</h2>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Event Summary</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for event in stats.recent_events %}
                <tr>
                    <td>{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') if event.timestamp else 'N/A' }}</td>
                    <td>
                        <code style="font-size: 0.9em;">
                            {{ (event.event_data | string)[:100] }}{% if (event.event_data | string)|length > 100 %}...{% endif %}
                        </code>
                    </td>
                    <td>
                        <a href="/events/{{ event.event_id }}">View Event</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<!-- Actions -->
<section style="margin-top: 2rem;">
    <h2>Actions</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <!-- Toggle Enable/Disable -->
        <form method="post" action="/event-listeners/{{ listener.id }}/toggle" style="display: inline;">
            <input type="hidden" name="enabled" value="{{ 'false' if listener.enabled else 'true' }}">
            <button type="submit" class="button">
                {% if listener.enabled %}Disable{% else %}Enable{% endif %} Listener
            </button>
        </form>
        
        <!-- Delete -->
        <form method="post" action="/event-listeners/{{ listener.id }}/delete" style="display: inline;" 
              onsubmit="return confirm('Are you sure you want to delete this listener? This action cannot be undone.');">
            <button type="submit" class="button" style="background-color: var(--bg-error); color: white;">
                Delete Listener
            </button>
        </form>
    </div>
</section>

<style>
    dl {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.5rem 1rem;
    }
    
    dt {
        font-weight: bold;
        text-align: right;
    }
    
    dd {
        margin: 0;
    }
    
    code {
        background-color: var(--bg-secondary);
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
    }
    
    pre code {
        background: none;
        padding: 0;
    }
    
    .language-python {
        color: var(--text);
    }
</style>

<!-- Include Prism.js for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

{% endblock %}