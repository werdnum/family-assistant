{% extends "base.html.j2" %}

{% block title %}{% if is_new %}Create New Event Listener{% else %}Edit Event Listener: {{ listener.name }}{% endif %}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/@codemirror/basic-setup/dist/codemirror.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/css/jsoneditor.min.css">
<style>
    .cm-editor { 
        border: 1px solid var(--border); 
        max-height: 400px;
        font-family: monospace;
    }
    .validation-error {
        color: var(--bg-error);
        margin-top: 0.5rem;
        font-weight: bold;
    }
    .validation-success {
        color: var(--accent);
        margin-top: 0.5rem;
    }
    .validation-pending {
        color: var(--text-light);
        margin-top: 0.5rem;
        font-style: italic;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        background-color: var(--bg);
        color: var(--text);
    }
    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }
    .checkbox-group {
        margin: 1rem 0;
    }
    .checkbox-group label {
        display: inline;
        font-weight: normal;
        margin-left: 0.5rem;
    }
    .form-actions {
        margin-top: 2rem;
        display: flex;
        gap: 1rem;
    }
    .json-editor-container {
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 1rem;
        background-color: var(--bg-secondary);
    }
    #script-editor-container {
        margin-bottom: 0.5rem;
    }
    .help-text {
        font-size: 0.9em;
        color: var(--text-light);
        margin-top: 0.25rem;
    }
    /* JSON Editor specific styles */
    .je-object__container {
        padding: 0;
    }
    .je-header {
        margin-bottom: 0.5rem;
    }
    .je-form-input-label {
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    .je-form-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        background-color: var(--bg);
        color: var(--text);
    }
    .je-form-input-description {
        font-size: 0.9em;
        color: var(--text-light);
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<h1>{% if is_new %}Create New Event Listener{% else %}Edit Event Listener: {{ listener.name }}{% endif %}</h1>

<nav style="margin-bottom: 2rem;">
    {% if is_new %}
    <a href="/event-listeners">← Back to Event Listeners</a>
    {% else %}
    <a href="/event-listeners/{{ listener.id }}">← Back to Listener Details</a>
    {% endif %}
</nav>

<form method="post" action="{% if is_new %}/event-listeners/create{% else %}/event-listeners/{{ listener.id }}/update{% endif %}" id="edit-form">
    <div class="form-group">
        <label for="name">Name</label>
        <input type="text" id="name" name="name" value="{{ listener.name }}" required>
        <div class="help-text">A unique name to identify this listener</div>
    </div>
    
    <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description">{{ listener.description or '' }}</textarea>
        <div class="help-text">Optional description of what this listener does</div>
    </div>
    
    <div class="form-group">
        <label for="source_id">Event Source</label>
        {% if is_new %}
        <select id="source_id" name="source_id">
            <option value="home_assistant" {% if listener.source_id == 'home_assistant' %}selected{% endif %}>Home Assistant</option>
            <option value="indexing" {% if listener.source_id == 'indexing' %}selected{% endif %}>Document Indexing</option>
            <option value="webhook" {% if listener.source_id == 'webhook' %}selected{% endif %}>Webhook</option>
        </select>
        <div class="help-text">Choose the event source to listen to</div>
        {% else %}
        <div style="padding: 0.5rem; background-color: var(--bg-secondary); border-radius: 4px;">
            <strong>{{ listener.source_id.replace('_', ' ').title() }}</strong>
        </div>
        <div class="help-text">Event source cannot be changed after creation</div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="action_type">Action Type</label>
        {% if is_new %}
        <select id="action_type" name="action_type">
            <option value="wake_llm" {% if listener.action_type == 'wake_llm' %}selected{% endif %}>LLM Callback</option>
            <option value="script" {% if listener.action_type == 'script' %}selected{% endif %}>Script</option>
        </select>
        <div class="help-text">Choose how the listener responds to events</div>
        {% else %}
        <div style="padding: 0.5rem; background-color: var(--bg-secondary); border-radius: 4px;">
            <strong>{{ 'LLM Callback' if listener.action_type == 'wake_llm' else 'Script' }}</strong>
        </div>
        <div class="help-text">Action type cannot be changed after creation</div>
        <input type="hidden" id="action_type" value="{{ listener.action_type }}">
        {% endif %}
    </div>
    
    <div class="form-group">
        <label>Match Conditions</label>
        <div id="match-conditions-editor" class="json-editor-container"></div>
        <input type="hidden" name="match_conditions" id="match-conditions-value" value="{{ listener.match_conditions | tojson }}">
        <div class="help-text">JSON conditions that events must match to trigger this listener</div>
    </div>
    
    <!-- Script fields (show/hide based on action type) -->
    <div id="script-fields" style="display: none;">
        <div class="form-group">
            <label>Script Code</label>
            <div id="script-editor-container">
                <div id="script-editor"></div>
            </div>
            <input type="hidden" name="script_code" id="script-code-value" value="{{ listener.action_config.script_code or '' }}">
            <div id="validation-status" class="validation-pending">Ready to validate...</div>
            <div class="help-text">Starlark script that will execute when the listener is triggered</div>
        </div>
        
        <div class="form-group">
            <label for="timeout">Timeout (seconds)</label>
            <input type="number" id="timeout" name="timeout" value="{{ listener.action_config.timeout or 600 }}" min="1" max="900">
            <div class="help-text">Maximum execution time for the script</div>
        </div>
    </div>
    
    <!-- LLM fields (show/hide based on action type) -->
    <div id="llm-fields" style="display: none;">
        <div class="form-group">
            <label for="llm_callback_prompt">LLM Callback Prompt</label>
            <textarea id="llm_callback_prompt" name="llm_callback_prompt">{{ listener.action_config.llm_callback_prompt or '' }}</textarea>
            <div class="help-text">Custom prompt to send to the LLM when this listener is triggered (optional)</div>
        </div>
    </div>
    
    <div class="checkbox-group">
        <input type="checkbox" id="one_time" name="one_time" {% if listener.one_time %}checked{% endif %}>
        <label for="one_time">One-time listener (auto-disable after first trigger)</label>
    </div>
    
    <div class="checkbox-group">
        <input type="checkbox" id="enabled" name="enabled" {% if listener.enabled %}checked{% endif %}>
        <label for="enabled">Enabled</label>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="button">{% if is_new %}Create Listener{% else %}Save Changes{% endif %}</button>
        <a href="{% if is_new %}/event-listeners{% else %}/event-listeners/{{ listener.id }}{% endif %}" class="button" style="background-color: var(--bg-secondary);">Cancel</a>
    </div>
</form>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
<script type="module">
import {EditorView, basicSetup} from "https://unpkg.com/@codemirror/basic-setup"
import {python} from "https://unpkg.com/@codemirror/lang-python"
import {EditorState} from "https://unpkg.com/@codemirror/state"

// Wait for all resources to load
window.addEventListener('load', () => {
    // Initialize match conditions JSON editor
    let matchConditionsEditor = null;

    try {
    const matchConditionsSchema = {
        type: "object",
        title: "Match Conditions",
        properties: {
            entity_id: {
                type: "string", 
                description: "Entity ID to match (for Home Assistant events)"
            },
            "new_state.state": {
                type: "string", 
                description: "State value to match (for Home Assistant state changes)"
            },
            document_type: {
                type: "string",
                description: "Document type to match (for indexing events)"
            }
        },
        additionalProperties: true
    };

    // Wait a bit for JSONEditor to be available
    if (typeof window.JSONEditor === 'undefined') {
        console.error('JSONEditor not loaded yet');
        // Try again after a delay
        setTimeout(() => {
            if (typeof window.JSONEditor !== 'undefined') {
                initializeJSONEditor();
            }
        }, 100);
    } else {
        initializeJSONEditor();
    }
    
    function initializeJSONEditor() {
        matchConditionsEditor = new window.JSONEditor(
            document.getElementById('match-conditions-editor'), 
            {
                schema: matchConditionsSchema,
                startval: {{ listener.match_conditions | tojson }},
                theme: 'html',
                disable_edit_json: false,
                disable_properties: false,
                disable_collapse: true,
                remove_button_labels: true,
                no_additional_properties: false
            }
        );
        window.matchConditionsEditor = matchConditionsEditor;
    }
} catch (e) {
    console.error('Error initializing JSON editor:', e);
}

// Script editor variables
let scriptEditor = null;
let validationTimeout;
window.scriptEditorInitialized = false;

// Function to initialize script editor
function initializeScriptEditor() {
    if (window.scriptEditorInitialized) return;
    
    const scriptCodeValue = document.getElementById('script-code-value').value || '';
    scriptEditor = new EditorView({
        state: EditorState.create({
            doc: scriptCodeValue,
            extensions: [
                basicSetup,
                python(), // Starlark is close enough to Python for syntax highlighting
                EditorView.updateListener.of((update) => {
                    if (update.docChanged) {
                        // Debounce validation
                        clearTimeout(validationTimeout);
                        document.getElementById('validation-status').textContent = 'Validating...';
                        document.getElementById('validation-status').className = 'validation-pending';
                        validationTimeout = setTimeout(() => validateScript(), 500);
                    }
                })
            ]
        }),
        parent: document.getElementById('script-editor')
    });
    
    window.scriptEditorInitialized = true;
    window.scriptEditor = scriptEditor;
    
    // Initial validation
    validateScript();
}

async function validateScript() {
    if (!scriptEditor) return;
    
    const statusDiv = document.getElementById('validation-status');
    const sourceId = {% if is_new %}document.getElementById('source_id').value{% else %}{{ listener.source_id | tojson }}{% endif %};
    
    try {
        const response = await fetch('/event-listeners/api/validate-script', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                script_code: scriptEditor.state.doc.toString(),
                sample_event: {
                    source_id: sourceId,
                    event_data: {}
                }
            })
        });
        
        const result = await response.json();
        if (result.valid) {
            statusDiv.textContent = '✓ Script is valid';
            statusDiv.className = 'validation-success';
        } else {
            const error = result.diagnostics[0];
            statusDiv.textContent = `✗ Line ${error.line}: ${error.message}`;
            statusDiv.className = 'validation-error';
        }
    } catch (e) {
        statusDiv.textContent = '⚠ Could not validate script';
        statusDiv.className = 'validation-error';
    }
}

// Function to show/hide action fields
function showActionFields() {
    const actionType = document.getElementById('action_type').value;
    const isScript = actionType === 'script';
    
    document.getElementById('script-fields').style.display = isScript ? 'block' : 'none';
    document.getElementById('llm-fields').style.display = isScript ? 'none' : 'block';
    
    // Initialize script editor on first show if needed
    if (isScript && !window.scriptEditorInitialized) {
        initializeScriptEditor();
    }
}

// Set up action type change handler
const actionTypeElement = document.getElementById('action_type');
if (actionTypeElement) {
    // For new listeners, it's a select element
    if (actionTypeElement.tagName === 'SELECT') {
        actionTypeElement.addEventListener('change', showActionFields);
    }
}

// Show correct fields on load
showActionFields();

// Form submission
document.getElementById('edit-form').addEventListener('submit', (e) => {
    // Update hidden fields with editor values
    if (window.matchConditionsEditor) {
        const matchConditionsErrors = window.matchConditionsEditor.validate();
        if (matchConditionsErrors.length > 0) {
            e.preventDefault();
            alert('Please fix errors in Match Conditions:\n' + 
                  matchConditionsErrors.map(err => err.path + ': ' + err.message).join('\n'));
            return;
        }
        
        document.getElementById('match-conditions-value').value = 
            JSON.stringify(window.matchConditionsEditor.getValue());
    } else {
        console.error('Match conditions editor not initialized');
        e.preventDefault();
        alert('Error: JSON editor not properly initialized. Please refresh the page.');
        return;
    }
    
    // Only update script code if script editor exists
    if (window.scriptEditor) {
        document.getElementById('script-code-value').value = 
            window.scriptEditor.state.doc.toString();
    }
});

}); // End of window.load
</script>
{% endblock %}