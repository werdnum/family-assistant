{% extends "base.html.j2" %}

{% block title %}{% if is_new %}Create New Event Listener{% else %}Edit Event Listener: {{ listener.name }}{% endif %}{% endblock %}

{% set llm_action_config = {} %}
{% if listener.action_type == 'wake_llm' and listener.action_config %}
    {% if listener.action_config.get('action_parameters') %}
        {% set _ = llm_action_config.update(listener.action_config.get('action_parameters', {})) %}
    {% endif %}
    {% if listener.action_config.get('llm_callback_prompt') %}
        {% set _ = llm_action_config.update({'llm_callback_prompt': listener.action_config.get('llm_callback_prompt')}) %}
    {% endif %}
{% endif %}

{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/@codemirror/basic-setup/dist/codemirror.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/css/jsoneditor.min.css">
<style>
    .cm-editor { 
        border: 1px solid var(--border); 
        max-height: 400px;
        font-family: monospace;
    }
    .validation-error {
        color: var(--bg-error);
        margin-top: 0.5rem;
        font-weight: bold;
    }
    .validation-success {
        color: var(--accent);
        margin-top: 0.5rem;
    }
    .validation-pending {
        color: var(--text-light);
        margin-top: 0.5rem;
        font-style: italic;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        background-color: var(--bg);
        color: var(--text);
    }
    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }
    .checkbox-group {
        margin: 1rem 0;
    }
    .checkbox-group label {
        display: inline;
        font-weight: normal;
        margin-left: 0.5rem;
    }
    .form-actions {
        margin-top: 2rem;
        display: flex;
        gap: 1rem;
    }
    .json-editor-container {
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 1rem;
        background-color: var(--bg-secondary);
    }
    #script-editor-container {
        margin-bottom: 0.5rem;
    }
    .help-text {
        font-size: 0.9em;
        color: var(--text-light);
        margin-top: 0.25rem;
    }
    /* JSON Editor specific styles */
    .je-object__container {
        padding: 0;
    }
    .je-header {
        margin-bottom: 0.5rem;
    }
    .je-form-input-label {
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    .je-form-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        background-color: var(--bg);
        color: var(--text);
    }
    .je-form-input-description {
        font-size: 0.9em;
        color: var(--text-light);
        margin-top: 0.25rem;
    }
    .json-editor-textarea {
        width: 100%;
        min-height: 200px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
        font-size: 13px;
        padding: 1rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        background-color: var(--bg);
        color: var(--text);
        resize: vertical;
        tab-size: 2;
        -moz-tab-size: 2;
    }
    .json-editor-textarea:focus {
        outline: none;
        border-color: var(--accent);
    }
    .json-error {
        color: var(--bg-error);
        font-size: 0.9em;
        margin-top: 0.25rem;
        font-weight: bold;
    }
    .json-valid {
        color: var(--accent);
        font-size: 0.9em;
        margin-top: 0.25rem;
    }
    /* CodeMirror styling */
    .CodeMirror {
        border: 1px solid var(--border);
        border-radius: 4px;
        background-color: var(--bg);
        color: var(--text);
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
        font-size: 13px;
        height: 300px;
    }
    .CodeMirror-gutters {
        background-color: var(--bg-secondary);
        border-right: 1px solid var(--border);
    }
    .CodeMirror-linenumber {
        color: var(--text-light);
    }
</style>
{% endblock %}

{% block content %}
<h1>{% if is_new %}Create New Event Listener{% else %}Edit Event Listener: {{ listener.name }}{% endif %}</h1>

<nav style="margin-bottom: 2rem;">
    {% if is_new %}
    <a href="/event-listeners">← Back to Event Listeners</a>
    {% else %}
    <a href="/event-listeners/{{ listener.id }}">← Back to Listener Details</a>
    {% endif %}
</nav>

<form method="post" action="{% if is_new %}/event-listeners/create{% else %}/event-listeners/{{ listener.id }}/update{% endif %}" id="edit-form">
    <div class="form-group">
        <label for="name">Name</label>
        <input type="text" id="name" name="name" value="{{ listener.name }}" required>
        <div class="help-text">A unique name to identify this listener</div>
    </div>
    
    <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description">{{ listener.description or '' }}</textarea>
        <div class="help-text">Optional description of what this listener does</div>
    </div>
    
    <div class="form-group">
        <label for="source_id">Event Source</label>
        {% if is_new %}
        <select id="source_id" name="source_id">
            <option value="home_assistant" {% if listener.source_id == 'home_assistant' %}selected{% endif %}>Home Assistant</option>
            <option value="indexing" {% if listener.source_id == 'indexing' %}selected{% endif %}>Document Indexing</option>
            <option value="webhook" {% if listener.source_id == 'webhook' %}selected{% endif %}>Webhook</option>
        </select>
        <div class="help-text">Choose the event source to listen to</div>
        {% else %}
        <div style="padding: 0.5rem; background-color: var(--bg-secondary); border-radius: 4px;">
            <strong>{{ listener.source_id.replace('_', ' ').title() }}</strong>
        </div>
        <div class="help-text">Event source cannot be changed after creation</div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="action_type">Action Type</label>
        {% if is_new %}
        <select id="action_type" name="action_type">
            <option value="wake_llm" {% if listener.action_type == 'wake_llm' %}selected{% endif %}>LLM Callback</option>
            <option value="script" {% if listener.action_type == 'script' %}selected{% endif %}>Script</option>
        </select>
        <div class="help-text">Choose how the listener responds to events</div>
        {% else %}
        <div style="padding: 0.5rem; background-color: var(--bg-secondary); border-radius: 4px;">
            <strong>{{ 'LLM Callback' if listener.action_type == 'wake_llm' else 'Script' }}</strong>
        </div>
        <div class="help-text">Action type cannot be changed after creation</div>
        <input type="hidden" id="action_type" value="{{ listener.action_type }}">
        {% endif %}
    </div>
    
    <div class="form-group">
        <label>Trigger Conditions</label>
        <div style="margin-bottom: 1rem;">
            <input type="radio" id="conditions-json" name="condition_type" value="json" {% if not listener.condition_script %}checked{% endif %}>
            <label for="conditions-json" style="display: inline; margin-left: 0.5rem; font-weight: normal;">JSON Match Conditions</label>
        </div>
        <div style="margin-bottom: 1rem;">
            <input type="radio" id="conditions-script" name="condition_type" value="script" {% if listener.condition_script %}checked{% endif %}>
            <label for="conditions-script" style="display: inline; margin-left: 0.5rem; font-weight: normal;">Starlark Condition Script</label>
        </div>
        
        <!-- JSON Match Conditions -->
        <div id="json-conditions-container" style="display: none;">
            <div id="match-conditions-editor" class="json-editor-container"></div>
            <input type="hidden" name="match_conditions" id="match-conditions-value" value="{{ listener.match_conditions | tojson }}">
            <div class="help-text">Define when this listener should trigger. Common fields: entity_id, new_state.state, document_type</div>
        </div>
        
        <!-- Starlark Condition Script -->
        <div id="script-conditions-container" style="display: none;">
            <div id="condition-script-editor-container">
                <div id="condition-script-editor"></div>
                <!-- Fallback textarea -->
                <textarea id="condition-script-fallback" class="json-editor-textarea" style="display: none;">{{ listener.condition_script or '' }}</textarea>
            </div>
            <input type="hidden" name="condition_script" id="condition-script-value" value="{{ listener.condition_script or '' }}">
            <div id="condition-validation-status" class="validation-pending">Ready to validate...</div>
            <div class="help-text">Starlark script that returns True/False to determine if the listener should trigger. The 'event' variable contains the event data.</div>
        </div>
    </div>
    
    <!-- Script fields (show/hide based on action type) -->
    <div id="script-fields" style="display: none;">
        <div class="form-group">
            <label>Script Code</label>
            <div id="script-editor-container">
                <div id="script-editor"></div>
                <!-- Fallback textarea that will be hidden when CodeMirror loads -->
                <textarea id="script-editor-fallback" class="json-editor-textarea" style="display: none;">{{ (listener.action_config or {}).get('script_code', '') }}</textarea>
            </div>
            <input type="hidden" name="script_code" id="script-code-value" value="{{ (listener.action_config or {}).get('script_code', '') }}">
            <div id="validation-status" class="validation-pending">Ready to validate...</div>
            <div class="help-text">Starlark script that will execute when the listener is triggered</div>
        </div>
        
        <div class="form-group">
            <label for="timeout">Timeout (seconds)</label>
            <input type="number" id="timeout" name="timeout" value="{{ (listener.action_config or {}).get('timeout', 600) }}" min="1" max="900">
            <div class="help-text">Maximum execution time for the script</div>
        </div>
    </div>
    
    <!-- LLM fields (show/hide based on action type) -->
    <div id="llm-fields" style="display: none;">
        <div class="form-group">
            <label>LLM Action Configuration</label>
            <div id="llm-action-editor" class="json-editor-container"></div>
            <input type="hidden" name="action_parameters" id="action-parameters-value" value="{{ (listener.action_config or {}).get('action_parameters', {}) | tojson }}">
            <input type="hidden" name="llm_callback_prompt" id="llm_callback_prompt" value="{{ (listener.action_config or {}).get('llm_callback_prompt', '') }}">
            <div class="help-text">Configure how the LLM responds. Common fields: tools (array of tool names), llm_callback_prompt (optional message)</div>
        </div>
    </div>
    
    <div class="checkbox-group">
        <input type="checkbox" id="one_time" name="one_time" {% if listener.one_time %}checked{% endif %}>
        <label for="one_time">One-time listener (auto-disable after first trigger)</label>
    </div>
    
    <div class="checkbox-group">
        <input type="checkbox" id="enabled" name="enabled" {% if listener.enabled %}checked{% endif %}>
        <label for="enabled">Enabled</label>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="button">{% if is_new %}Create Listener{% else %}Save Changes{% endif %}</button>
        <a href="{% if is_new %}/event-listeners{% else %}/event-listeners/{{ listener.id }}{% endif %}" class="button" style="background-color: var(--bg-secondary);">Cancel</a>
    </div>
</form>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
<!-- Use bundled CodeMirror 5 which works with regular script tags -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script>
// Regular script for JSONEditor initialization
// Initialize when DOM is ready
function initializeEditors() {
    console.log('Initializing editors...');
    
    // Initialize JSON editors
    let matchConditionsEditor = null;
    let llmActionEditor = null;

    // Debug: Check if containers exist
    const matchConditionsContainer = document.getElementById('match-conditions-editor');
    const llmActionContainer = document.getElementById('llm-action-editor');
    
    if (!matchConditionsContainer) {
        console.error('Match conditions editor container not found!');
        return;
    }
    
    try {
    const matchConditionsSchema = {
        type: "object",
        title: "Match Conditions",
        properties: {
            entity_id: {
                type: "string", 
                description: "Entity ID to match (for Home Assistant events)"
            },
            "new_state.state": {
                type: "string", 
                description: "State value to match (for Home Assistant state changes)"
            },
            document_type: {
                type: "string",
                description: "Document type to match (for indexing events)"
            }
        },
        additionalProperties: true
    };
    
    const llmActionSchema = {
        type: "object",
        title: "LLM Action Configuration",
        properties: {
            tools: {
                type: "array",
                description: "List of tool names to enable for the LLM",
                items: {
                    type: "string"
                },
                default: []
            },
            llm_callback_prompt: {
                type: "string",
                description: "Optional custom prompt to send to the LLM when triggered",
                default: ""
            }
        },
        additionalProperties: true
    };

    // Initialize JSONEditor with retry logic
    let retryCount = 0;
    const maxRetries = 20; // 2 seconds total
    
    function tryInitializeJSONEditor() {
        if (typeof window.JSONEditor !== 'undefined') {
            console.log('JSONEditor loaded, initializing...');
            initializeJSONEditor();
        } else if (retryCount < maxRetries) {
            retryCount++;
            console.log(`JSONEditor not loaded yet, retry ${retryCount}/${maxRetries}...`);
            setTimeout(tryInitializeJSONEditor, 100);
        } else {
            console.error('JSONEditor failed to load after 2 seconds, keeping fallback editors');
            // Just add a warning message
            matchConditionsContainer.insertAdjacentHTML('afterend', '<div class="help-text" style="color: var(--bg-error);">JSON editor failed to load. Using plain text editor.</div>');
        }
    }
    
    tryInitializeJSONEditor();
    
    function initializeJSONEditor() {
        try {
            console.log('Creating JSONEditor instances...');
            
            // Initialize match conditions editor
            matchConditionsEditor = new window.JSONEditor(
                document.getElementById('match-conditions-editor'), 
                {
                    schema: matchConditionsSchema,
                    startval: {{ listener.match_conditions | tojson | safe }},
                    theme: 'html',
                    disable_edit_json: false,
                    disable_properties: false,
                    disable_collapse: true,
                    remove_button_labels: true,
                    no_additional_properties: false
                }
            );
            window.matchConditionsEditor = matchConditionsEditor;
            
            // Initialize LLM action editor if container exists
            if (llmActionContainer) {
                llmActionEditor = new window.JSONEditor(
                    document.getElementById('llm-action-editor'), 
                    {
                        schema: llmActionSchema,
                        startval: {{ llm_action_config | tojson | safe }},
                        theme: 'html',
                        disable_edit_json: false,
                        disable_properties: false,
                        disable_collapse: true,
                        remove_button_labels: true,
                        no_additional_properties: false
                    }
                );
                window.llmActionEditor = llmActionEditor;
            }
            
            console.log('JSONEditor instances initialized successfully');
        } catch (innerError) {
            console.error('Error creating JSONEditor instances:', innerError);
            throw innerError;
        }
    }
} catch (e) {
    console.error('Error in JSON editor initialization:', e);
    // Show error message to user
    const matchConditionsContainer = document.getElementById('match-conditions-editor');
    const llmActionContainer = document.getElementById('llm-action-editor');
    
    if (matchConditionsContainer) {
        matchConditionsContainer.innerHTML = '<div style="color: var(--bg-error); padding: 1rem;">Error loading JSON editor. Please refresh the page.</div>';
    }
    if (llmActionContainer) {
        llmActionContainer.innerHTML = '<div style="color: var(--bg-error); padding: 1rem;">Error loading JSON editor. Please refresh the page.</div>';
    }
}

// Script editor variables
let scriptEditor = null;
let conditionScriptEditor = null;
let validationTimeout;
window.scriptEditorInitialized = false;
window.conditionScriptEditorInitialized = false;
window.validationTimeout = null;

// Function to initialize script editor
function initializeScriptEditor() {
    const fallbackTextarea = document.getElementById('script-editor-fallback');
    const container = document.getElementById('script-editor');
    
    // Try to use CodeMirror 5 if available
    if (typeof CodeMirror !== 'undefined' && container) {
        try {
            const scriptCodeValue = document.getElementById('script-code-value').value || '';
            
            // Initialize CodeMirror 5
            window.scriptEditor = CodeMirror(container, {
                value: scriptCodeValue,
                mode: 'python',  // Starlark is similar to Python
                theme: 'default',
                lineNumbers: true,
                indentUnit: 4,
                lineWrapping: true,
                extraKeys: {
                    "Tab": function(cm) {
                        cm.replaceSelection("    ", "end");
                    }
                }
            });
            
            // Hide fallback textarea
            if (fallbackTextarea) {
                fallbackTextarea.style.display = 'none';
            }
            
            // Set up change handler for validation
            window.scriptEditor.on('change', function() {
                clearTimeout(window.validationTimeout);
                document.getElementById('validation-status').textContent = 'Validating...';
                document.getElementById('validation-status').className = 'validation-pending';
                window.validationTimeout = setTimeout(() => window.validateScript(), 500);
            });
            
            window.scriptEditorInitialized = true;
            console.log('CodeMirror 5 script editor initialized');
            
            // Initial validation
            window.validateScript();
        } catch (error) {
            console.error('Failed to initialize CodeMirror:', error);
            // Show fallback
            if (fallbackTextarea) {
                fallbackTextarea.style.display = 'block';
            }
        }
    } else {
        console.log('CodeMirror not available, using fallback textarea');
        // Show fallback
        if (fallbackTextarea) {
            fallbackTextarea.style.display = 'block';
        }
    }
}

// Function to initialize condition script editor
function initializeConditionScriptEditor() {
    const fallbackTextarea = document.getElementById('condition-script-fallback');
    const container = document.getElementById('condition-script-editor');
    
    // Try to use CodeMirror 5 if available
    if (typeof CodeMirror !== 'undefined' && container) {
        try {
            const conditionScriptValue = document.getElementById('condition-script-value').value || '';
            
            // Initialize CodeMirror 5
            window.conditionScriptEditor = CodeMirror(container, {
                value: conditionScriptValue,
                mode: 'python',  // Starlark is similar to Python
                theme: 'default',
                lineNumbers: true,
                indentUnit: 4,
                lineWrapping: true,
                extraKeys: {
                    "Tab": function(cm) {
                        cm.replaceSelection("    ", "end");
                    }
                }
            });
            
            // Hide fallback textarea
            if (fallbackTextarea) {
                fallbackTextarea.style.display = 'none';
            }
            
            // Set up change handler for validation
            window.conditionScriptEditor.on('change', function() {
                clearTimeout(window.validationTimeout);
                document.getElementById('condition-validation-status').textContent = 'Validating...';
                document.getElementById('condition-validation-status').className = 'validation-pending';
                window.validationTimeout = setTimeout(() => window.validateConditionScript(), 500);
            });
            
            window.conditionScriptEditorInitialized = true;
            console.log('CodeMirror 5 condition script editor initialized');
            
            // Initial validation
            window.validateConditionScript();
        } catch (error) {
            console.error('Failed to initialize condition script CodeMirror:', error);
            // Show fallback
            if (fallbackTextarea) {
                fallbackTextarea.style.display = 'block';
            }
        }
    } else {
        console.log('CodeMirror not available for condition script, using fallback textarea');
        // Show fallback
        if (fallbackTextarea) {
            fallbackTextarea.style.display = 'block';
        }
    }
}

async function validateScript() {
    if (!window.scriptEditor) return;
    
    const statusDiv = document.getElementById('validation-status');
    const sourceElement = document.getElementById('source_id');
    const sourceId = sourceElement ? sourceElement.value : null;
    
    try {
        const requestBody = {
            script_code: window.scriptEditor.getValue()  // CodeMirror 5 API
        };
        
        // Only include sample_event if we have a source ID
        if (sourceId) {
            requestBody.sample_event = {
                source_id: sourceId,
                event_data: {}
            };
        }
        
        const response = await fetch('/event-listeners/api/validate-script', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });
        
        const result = await response.json();
        if (result.valid) {
            statusDiv.textContent = '✓ Script is valid';
            statusDiv.className = 'validation-success';
        } else {
            const error = result.diagnostics[0];
            statusDiv.textContent = `✗ Line ${error.line}: ${error.message}`;
            statusDiv.className = 'validation-error';
        }
    } catch (e) {
        statusDiv.textContent = '⚠ Could not validate script';
        statusDiv.className = 'validation-error';
    }
}

// Make validateScript globally available
window.validateScript = validateScript;

async function validateConditionScript() {
    if (!window.conditionScriptEditor) return;
    
    const statusDiv = document.getElementById('condition-validation-status');
    const sourceElement = document.getElementById('source_id');
    const sourceId = sourceElement ? sourceElement.value : null;
    
    try {
        const requestBody = {
            script_code: window.conditionScriptEditor.getValue()  // CodeMirror 5 API
        };
        
        // Only include sample_event if we have a source ID
        if (sourceId) {
            requestBody.sample_event = {
                source_id: sourceId,
                event_data: {}
            };
        }
        
        const response = await fetch('/event-listeners/api/validate-script', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });
        
        const result = await response.json();
        if (result.valid) {
            statusDiv.textContent = '✓ Condition script is valid';
            statusDiv.className = 'validation-success';
        } else {
            const error = result.diagnostics[0];
            statusDiv.textContent = `✗ Line ${error.line}: ${error.message}`;
            statusDiv.className = 'validation-error';
        }
    } catch (e) {
        statusDiv.textContent = '⚠ Could not validate condition script';
        statusDiv.className = 'validation-error';
    }
}

// Make validateConditionScript globally available
window.validateConditionScript = validateConditionScript;

// Function to show/hide condition type containers
function showConditionFields() {
    const conditionType = document.querySelector('input[name="condition_type"]:checked').value;
    const isScript = conditionType === 'script';
    
    document.getElementById('json-conditions-container').style.display = isScript ? 'none' : 'block';
    document.getElementById('script-conditions-container').style.display = isScript ? 'block' : 'none';
    
    // Clear the inactive field's value to ensure only the active condition type is submitted
    if (isScript) {
        // Using script, clear JSON conditions value
        document.getElementById('match-conditions-value').value = '{}';
    } else {
        // Using JSON, clear condition script value
        document.getElementById('condition-script-value').value = '';
    }
    
    // Initialize condition script editor on first show if needed
    if (isScript && !window.conditionScriptEditorInitialized) {
        initializeConditionScriptEditor();
    }
}

// Function to show/hide action fields
function showActionFields() {
    const actionType = document.getElementById('action_type').value;
    const isScript = actionType === 'script';
    
    document.getElementById('script-fields').style.display = isScript ? 'block' : 'none';
    document.getElementById('llm-fields').style.display = isScript ? 'none' : 'block';
    
    // Initialize script editor on first show if needed
    if (isScript && !window.scriptEditorInitialized) {
        initializeScriptEditor();
    }
}

// Set up condition type change handlers
const conditionTypeRadios = document.querySelectorAll('input[name="condition_type"]');
conditionTypeRadios.forEach(radio => {
    radio.addEventListener('change', showConditionFields);
});

// Set up action type change handler
const actionTypeElement = document.getElementById('action_type');
if (actionTypeElement) {
    // For new listeners, it's a select element
    if (actionTypeElement.tagName === 'SELECT') {
        actionTypeElement.addEventListener('change', showActionFields);
    }
}

// Show correct fields on load
showConditionFields();
showActionFields();

// Form submission
document.getElementById('edit-form').addEventListener('submit', (e) => {
    // Update hidden fields with editor values
    if (window.matchConditionsEditor) {
        const matchConditionsErrors = window.matchConditionsEditor.validate();
        if (matchConditionsErrors.length > 0) {
            e.preventDefault();
            alert('Please fix errors in Match Conditions:\n' + 
                  matchConditionsErrors.map(err => err.path + ': ' + err.message).join('\n'));
            return;
        }
        
        document.getElementById('match-conditions-value').value = 
            JSON.stringify(window.matchConditionsEditor.getValue());
    } else {
        // Use fallback textarea
        const fallbackTextarea = document.getElementById('match-conditions-fallback');
        if (fallbackTextarea) {
            try {
                // Validate JSON
                JSON.parse(fallbackTextarea.value);
                document.getElementById('match-conditions-value').value = fallbackTextarea.value;
            } catch (err) {
                e.preventDefault();
                alert('Invalid JSON in Match Conditions: ' + err.message);
                return;
            }
        } else {
            console.error('No match conditions editor available');
            e.preventDefault();
            alert('Error: No editor available. Please refresh the page.');
            return;
        }
    }
    
    // Update LLM action configuration
    if (window.llmActionEditor) {
        const llmActionErrors = window.llmActionEditor.validate();
        if (llmActionErrors.length > 0) {
            e.preventDefault();
            alert('Please fix errors in LLM Action Configuration:\n' + 
                  llmActionErrors.map(err => err.path + ': ' + err.message).join('\n'));
            return;
        }
        
        // Get the unified config
        const llmConfig = window.llmActionEditor.getValue();
        
        // Split into action_parameters and llm_callback_prompt
        const actionParams = {};
        if (llmConfig.tools && llmConfig.tools.length > 0) {
            actionParams.tools = llmConfig.tools;
        }
        
        document.getElementById('action-parameters-value').value = 
            JSON.stringify(actionParams);
        document.getElementById('llm_callback_prompt').value = 
            llmConfig.llm_callback_prompt || '';
    }
    
    // Update script code from editor or fallback
    if (window.scriptEditor && window.scriptEditor.getValue) {
        document.getElementById('script-code-value').value = 
            window.scriptEditor.getValue();  // CodeMirror 5 API
    } else {
        // Use fallback textarea if CodeMirror didn't load
        const fallbackTextarea = document.getElementById('script-editor-fallback');
        if (fallbackTextarea) {
            document.getElementById('script-code-value').value = fallbackTextarea.value;
        }
    }
    
    // Update condition script from editor or fallback
    if (window.conditionScriptEditor && window.conditionScriptEditor.getValue) {
        document.getElementById('condition-script-value').value = 
            window.conditionScriptEditor.getValue();  // CodeMirror 5 API
    } else {
        // Use fallback textarea if CodeMirror didn't load
        const fallbackTextarea = document.getElementById('condition-script-fallback');
        if (fallbackTextarea) {
            document.getElementById('condition-script-value').value = fallbackTextarea.value;
        }
    }
});

} // End of initializeEditors

// Check if DOM is already loaded, otherwise wait for it
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEditors);
} else {
    // DOM is already loaded, initialize immediately
    initializeEditors();
}
</script>
{% endblock %}